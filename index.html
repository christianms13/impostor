<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÄ Impostor Coquette</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* --- EST√âTICA COQUETTE DARK --- */
        :root {
            --bg-color: #16080d; /* Negro rojizo muy oscuro */
            --card-bg: #241218;
            --pink-soft: #ffc2d1;
            --pink-hot: #ff8fab;
            --pearl: #fff0f3;
            --text-main: #ffe5ec;
            --danger: #ff4d6d;
            --font-main: 'Georgia', 'Times New Roman', serif;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* FONDO DE EMOJIS SUTIL */
        body::before {
            content: "üéÄ ü¶¢ ü©∞ üíÑ üïØÔ∏è üçí üß∏ üßÅ";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            font-size: 2rem;
            opacity: 0.03; /* Muy sutil */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 40px;
            z-index: -1;
            pointer-events: none;
            letter-spacing: 30px;
            line-height: 3;
        }

        h1 {
            color: var(--pink-soft);
            font-style: italic;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(255, 194, 209, 0.3);
        }
        
        .tagline { font-size: 0.8rem; color: var(--pink-hot); opacity: 0.8; margin-bottom: 20px; }

        .container {
            background-color: var(--card-bg);
            border: 1px solid rgba(255, 194, 209, 0.2);
            padding: 2.5rem;
            border-radius: 25px; /* Bordes muy redondos */
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            backdrop-filter: blur(5px);
        }

        /* Decoraci√≥n lazo */
        .container::after {
            content: 'üéÄ';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            text-shadow: 0 5px 10px rgba(0,0,0,0.5);
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 12px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--pink-hot);
            border-radius: 15px;
            color: var(--pearl);
            font-family: inherit;
            font-size: 1rem;
            outline: none;
            text-align: center;
            transition: 0.3s;
        }
        input:focus { border-color: var(--pearl); box-shadow: 0 0 15px rgba(255, 143, 171, 0.3); }

        button {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            background: linear-gradient(45deg, var(--pink-hot), #ffb3c6);
            border: none;
            border-radius: 20px;
            color: #4a0a1d;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(255, 143, 171, 0.3);
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 143, 171, 0.5); filter: brightness(1.1); }
        
        button.secondary { 
            background: transparent; 
            border: 1px solid var(--pink-soft); 
            color: var(--pink-soft); 
            box-shadow: none;
        }
        button.secondary:hover { background: rgba(255, 194, 209, 0.1); color: white; }

        button.danger { background: linear-gradient(45deg, #d90429, #ff4d6d); color: white; }

        .hidden { display: none !important; }

        /* LISTAS */
        .player-list, .turn-order-list { list-style: none; padding: 0; text-align: left; }
        
        .player-list li {
            border-bottom: 1px dashed var(--pink-hot); 
            padding: 12px 0;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--pearl);
        }

        .turn-order-list { margin-top: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; }
        .turn-order-list li { padding: 8px; font-size: 0.95rem; color: #ccaadd; border-bottom: 1px dotted #444; }
        .turn-order-list li:last-child { border-bottom: none; }
        .turn-order-list li:first-child { 
            color: var(--pink-soft); 
            font-weight: bold; 
            font-style: italic;
        }
        .turn-order-list li:first-child::after { content: " ‚ú® (Empieza)"; font-size: 0.8rem; }

        /* JUEGO */
        .role-title { font-size: 1.2rem; color: var(--pink-soft); margin-bottom: 5px; }
        
        .secret-word {
            font-size: 2.2rem; color: var(--pearl); 
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--pink-hot);
            border-radius: 15px;
            padding: 20px; margin: 15px 0;
            text-shadow: 0 0 15px var(--pink-hot);
            word-break: break-word;
        }

        .word-description {
            font-size: 0.9rem;
            color: #e0c3fc;
            font-style: italic;
            line-height: 1.4;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        
        .impostor-text { 
            color: var(--danger); 
            font-size: 2.5rem; 
            text-shadow: 0 0 20px rgba(255, 77, 109, 0.6); 
            letter-spacing: 5px;
            margin: 20px 0;
        }
        
        .kick-btn {
            width: auto; padding: 5px 12px; margin: 0 0 0 10px;
            font-size: 0.7rem; background: transparent; border: 1px solid var(--danger); color: var(--danger);
            border-radius: 10px;
        }
        .kick-btn:hover { background: var(--danger); color: white; }

        #roomIdDisplay { 
            font-family: monospace; letter-spacing: 2px; font-weight: bold; color: var(--pink-soft);
            cursor: pointer; border-style: dashed;
        }

    </style>
</head>
<body>

    <h1>The Impostor</h1>
    <div class="tagline">‚ú® Coquette Edition ‚ú®</div>
    <div id="statusMsg" style="font-size: 0.8rem; color: #aaa; min-height: 1rem; margin-bottom: 10px;"></div>

    <div id="screen-menu" class="container">
        <p style="text-align: center; color: var(--pearl);">¬øQui√©n eres hoy?</p>
        <input type="text" id="myUsername" placeholder="Tu nombre lindo..." maxlength="12">
        <button onclick="createGame()">Crear Sala ‚ú®</button>
        <div style="margin: 20px 0; display: flex; align-items: center; color: #555;">
            <hr style="flex:1; border-color: #442;"> <span style="padding:0 10px;">o</span> <hr style="flex:1; border-color: #442;">
        </div>
        <input type="text" id="joinInput" placeholder="Pegar c√≥digo de sala">
        <button class="secondary" onclick="joinGame()">Unirse a una sala ü¶¢</button>
    </div>

    <div id="screen-lobby" class="container hidden">
        <h2>Sala de Espera üß∏</h2>
        <p style="font-size: 0.8rem; color: #bbb;">Toca el c√≥digo para copiarlo:</p>
        
        <input type="text" id="roomIdDisplay" readonly onclick="copyRoomCode()">

        <h3 style="margin-top: 20px; border-bottom: 1px solid #442; padding-bottom: 5px;">Amigas conectadas (<span id="playerCount">0</span>)</h3>
        <ul id="lobbyList" class="player-list"></ul>

        <div id="hostControls" class="hidden" style="margin-top: 25px;">
            <div style="background: rgba(255, 194, 209, 0.05); padding: 10px; border-radius: 10px; font-size: 0.8rem; color: #d8bfd8; margin-bottom: 15px;">
                ‚ÑπÔ∏è <b>Modo Infinito:</b> Las palabras vendr√°n de Wikipedia con una peque√±a descripci√≥n para ayudar.
            </div>
            <button onclick="startGame()" id="btnStart">‚ú® Empezar Partida ‚ú®</button>
        </div>
        <div id="clientWaiting" class="hidden">
            <p style="color: var(--pink-soft); animation: pulse 2s infinite;">Esperando a la anfitriona... üéÄ</p>
        </div>
    </div>

    <div id="screen-game" class="container hidden">
        <div class="role-card">
            <p class="role-title">Tu identidad secreta es:</p>
            <h3 id="roleDisplay" style="font-size: 1.5rem; margin: 5px 0;">...</h3>
            
            <div id="wordContainer">
                <hr style="border-color: #442; margin: 20px 0; opacity: 0.5;">
                <p style="font-size:0.8rem; color: #bbb;">LA PALABRA ES:</p>
                <div id="secretWordDisplay" class="secret-word">???</div>
                
                <div id="secretDescDisplay" class="word-description">Cargando definici√≥n...</div>
            </div>
            
            <div id="impostorMessage" class="hidden">
                <hr style="border-color: #442; margin: 20px 0; opacity: 0.5;">
                <div class="impostor-text">IMPOSTOR</div>
                <p style="color: var(--pearl);">Shhh... ü§´<br>No sabes la palabra.<br>Finge hasta el final.</p>
            </div>

            <div style="margin-top: 30px;">
                <p style="font-size: 0.9rem; color: var(--pink-soft); text-align: left;">ü©∞ Orden de turnos:</p>
                <ol id="turnOrderList" class="turn-order-list"></ol>
            </div>
        </div>
        
        <div id="hostGameControls" class="hidden" style="margin-top: 20px;">
            <button class="danger" onclick="revealGame()">üíî Terminar y Revelar</button>
        </div>
        <p id="waitingReveal" class="hidden" style="margin-top:20px; color:#888; font-size: 0.8rem;">La partida est√° en curso...</p>
    </div>

    <div id="screen-result" class="container hidden">
        <h2 style="color: var(--pearl);">Resultados</h2>
        
        <p style="color:#aaa; font-size: 0.9rem;">La palabra era:</p>
        <div id="finalWord" style="font-size: 1.8rem; color: var(--pink-hot); margin-bottom: 5px; font-weight: bold;"></div>
        <p id="finalDesc" style="font-size: 0.8rem; color: #aaa; font-style: italic; margin-bottom: 20px;"></p>
        
        <hr style="border-color: #333;">

        <p style="color:#aaa; font-size: 0.9rem;">El impostor era:</p>
        <h3 id="finalImpostor" style="font-size: 2rem; color: var(--danger); margin-top: 5px;"></h3>
        
        <div id="hostRestartControls" class="hidden">
            <button onclick="returnToLobby()">üîÑ Volver al Lobby</button>
        </div>
        <p id="clientRestartWaiting" class="hidden" style="color:#666;">Esperando al Host...</p>
    </div>

    <script>
        // --- L√ìGICA DE CONEXI√ìN ---
        let peer = null;
        let connections = [];
        let isHost = false;
        let myName = "";
        let players = []; 
        let gameState = {}; 
        
        const screens = ['menu', 'lobby', 'game', 'result'];

        function showScreen(name) {
            screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
            document.getElementById(`screen-${name}`).classList.remove('hidden');
        }

        function updateStatus(msg) { document.getElementById('statusMsg').innerText = msg; }

        // --- CEREBRO MEJORADO: WIKIPEDIA + DESCRIPCIONES ---
        async function fetchSmartWord() {
            // Usamos generator=random para obtener p√°ginas Y prop=extracts para sacar el resumen
            // limit=10 para no saturar, pero pedimos intros
            const url = "https://es.wikipedia.org/w/api.php?action=query&generator=random&grnnamespace=0&grnlimit=15&prop=extracts&exintro&explaintext&exchars=200&format=json&origin=*";
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageValues = Object.values(pages);

                // FILTRO AVANZADO:
                // 1. Debe tener extracto (descripci√≥n).
                // 2. El t√≠tulo no debe ser "raro" (sin par√©ntesis, dos puntos, n√∫meros solos).
                // 3. La descripci√≥n no debe ser vac√≠a ni decir "se refiere a".
                
                let validPages = pageValues.filter(p => {
                    const t = p.title;
                    const desc = p.extract;

                    if (!desc || desc.length < 15) return false; // Sin descripci√≥n √∫til
                    if (t.includes("(") || t.includes(":")) return false; // T√≠tulos t√©cnicos
                    if (/^\d+$/.test(t)) return false; // A√±os
                    if (t.startsWith("Anexo")) return false; 
                    if (desc.includes("puede referirse a")) return false; // Desambiguaci√≥n

                    return true;
                });

                if (validPages.length === 0) validPages = pageValues; // Fallback p√°nico

                // ORDENAR POR LONGITUD DE T√çTULO (M√°s corto = M√°s com√∫n generalmente)
                validPages.sort((a, b) => a.title.length - b.title.length);

                // Elegir uno de los mejores 5
                const topPicks = validPages.slice(0, 5); 
                const winner = topPicks[Math.floor(Math.random() * topPicks.length)];

                // Limpiar la descripci√≥n un poco (quitar saltos de l√≠nea)
                let cleanDesc = winner.extract.replace(/\n/g, " ").substring(0, 180);
                if(winner.extract.length > 180) cleanDesc += "...";

                return { title: winner.title, desc: cleanDesc };

            } catch (e) {
                console.error("Wiki Error:", e);
                return { title: "Amor", desc: "Sentimiento de vivo afecto e inclinaci√≥n hacia una persona o cosa." };
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- FUNCIONES PEERJS ---
        function createGame() {
            myName = document.getElementById('myUsername').value.trim() || "Cinnamon Roll";
            isHost = true;
            updateStatus("Creando salita... üéÄ");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                document.getElementById('roomIdDisplay').value = id;
                updateStatus("");
                players = [{ id: id, name: myName, isHost: true }];
                updateLobbyUI();
                showScreen('lobby');
                document.getElementById('hostControls').classList.remove('hidden');
            });

            peer.on('connection', (c) => {
                c.on('open', () => { c.on('data', (d) => handleDataHost(d, c)); });
                c.on('close', () => {
                    players = players.filter(p => p.id !== c.peer);
                    connections = connections.filter(con => con.peer !== c.peer);
                    broadcastLobby();
                });
            });
        }

        function joinGame() {
            myName = document.getElementById('myUsername').value.trim() || "Baby Angel";
            const roomId = document.getElementById('joinInput').value.trim();
            if (!roomId) return alert("¬°Ups! Falta el c√≥digo ü•∫");
            
            isHost = false;
            updateStatus("Buscando... ü¶¢");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                const conn = peer.connect(roomId);
                conn.on('open', () => {
                    updateStatus("¬°Conectada! ‚ú®");
                    conn.send({ type: 'JOIN', name: myName, id: id });
                    connections = [conn]; 
                });
                conn.on('data', (d) => handleDataClient(d));
                conn.on('close', () => { alert("La sala se cerr√≥ üíî"); location.reload(); });
            });
            peer.on('error', () => alert("No encuentro esa sala ü•∫"));
        }

        // --- DATA HANDLING ---
        function handleDataHost(data, connSource) {
            if (data.type === 'JOIN') {
                if (!players.find(p => p.id === data.id)) {
                    connections.push(connSource);
                    players.push({ id: data.id, name: data.name });
                    broadcastLobby();
                }
            }
        }

        function handleDataClient(data) {
            if (data.type === 'LOBBY') {
                players = data.players;
                showScreen('lobby');
                document.getElementById('playerCount').innerText = players.length;
                updateLobbyUI();
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('clientWaiting').classList.remove('hidden');
            }
            if (data.type === 'START') setupGame(data.wordData, data.impostor, data.order);
            if (data.type === 'REVEAL') showResult(data.wordData, data.impostorName);
            if (data.type === 'RESET') showScreen('lobby');
        }

        function broadcastLobby() {
            const safePlayers = players.map(p => ({ id: p.id, name: p.name, isHost: p.isHost }));
            const msg = { type: 'LOBBY', players: safePlayers };
            if (!isHost) return;
            updateLobbyUI();
            connections.forEach(c => c.send(msg));
        }

        // --- GAME LOGIC ---
        async function startGame() {
            if (players.length < 3 && !confirm("Son poquitos (menos de 3). ¬øJugamos igual? ü•∫")) return;
            
            const btn = document.getElementById('btnStart');
            btn.innerText = "Eligiendo palabra m√°gica... ‚ú®";
            btn.disabled = true;

            // 1. Obtener palabra + descripci√≥n
            const wordData = await fetchSmartWord(); // Retorna {title, desc}
            
            const impostor = players[Math.floor(Math.random() * players.length)];
            
            // Orden aleatorio
            let turnOrder = [...players];
            turnOrder = shuffleArray(turnOrder).map(p => p.name);

            gameState = { wordData: wordData, impostorName: impostor.name };
            
            const msg = { 
                type: 'START', 
                wordData: wordData, 
                impostor: impostor.id,
                order: turnOrder
            };
            
            connections.forEach(c => c.send(msg));
            setupGame(wordData, impostor.id, turnOrder);

            btn.innerText = "‚ú® Empezar Partida ‚ú®";
            btn.disabled = false;
        }

        function setupGame(wordData, impostorId, orderList) {
            showScreen('game');
            const amIImpostor = (peer.id === impostorId);
            
            const roleTxt = document.getElementById('roleDisplay');
            if (amIImpostor) {
                roleTxt.innerText = "üíî Eres la IMPOSTORA";
                roleTxt.style.color = "var(--danger)";
                document.getElementById('wordContainer').classList.add('hidden');
                document.getElementById('impostorMessage').classList.remove('hidden');
            } else {
                roleTxt.innerText = "üíñ Eres CIUDADANA";
                roleTxt.style.color = "var(--pink-hot)";
                document.getElementById('wordContainer').classList.remove('hidden');
                document.getElementById('impostorMessage').classList.add('hidden');
                
                document.getElementById('secretWordDisplay').innerText = wordData.title;
                document.getElementById('secretDescDisplay').innerText = wordData.desc;
            }

            const ul = document.getElementById('turnOrderList');
            ul.innerHTML = '';
            orderList.forEach((name, index) => {
                const li = document.createElement('li');
                li.innerText = `${index + 1}. ${name}`;
                ul.appendChild(li);
            });

            if (isHost) {
                document.getElementById('hostGameControls').classList.remove('hidden');
                document.getElementById('waitingReveal').classList.add('hidden');
            } else {
                document.getElementById('hostGameControls').classList.add('hidden');
                document.getElementById('waitingReveal').classList.remove('hidden');
            }
        }

        function revealGame() {
            const msg = { type: 'REVEAL', wordData: gameState.wordData, impostorName: gameState.impostorName };
            connections.forEach(c => c.send(msg));
            showResult(msg.wordData, msg.impostorName);
        }

        function showResult(wordData, impostorName) {
            showScreen('result');
            document.getElementById('finalWord').innerText = wordData.title;
            document.getElementById('finalDesc').innerText = wordData.desc;
            document.getElementById('finalImpostor').innerText = impostorName;
            
            if(isHost) {
                document.getElementById('hostRestartControls').classList.remove('hidden');
                document.getElementById('clientRestartWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostRestartControls').classList.add('hidden');
                document.getElementById('clientRestartWaiting').classList.remove('hidden');
            }
        }

        function returnToLobby() {
            broadcastLobby();
            connections.forEach(c => c.send({ type: 'RESET' }));
            showScreen('lobby');
        }

        function kickPlayer(id) {
            if(!confirm("¬øSacar a esta persona de la sala? üíî")) return;
            const conn = connections.find(c => c.peer === id);
            if (conn) conn.close();
            players = players.filter(p => p.id !== id);
            connections = connections.filter(c => c.peer !== id);
            broadcastLobby();
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobbyList');
            list.innerHTML = '';
            players.forEach(p => {
                const li = document.createElement('li');
                let html = `<span>${p.name} ${p.isHost ? 'üëë' : ''}</span>`;
                if(isHost && p.id !== peer.id) {
                    html += `<button class="kick-btn" onclick="kickPlayer('${p.id}')">Bye</button>`;
                }
                li.innerHTML = html;
                list.appendChild(li);
            });
        }

        function copyRoomCode() {
            const el = document.getElementById('roomIdDisplay');
            el.select();
            navigator.clipboard.writeText(el.value);
            el.style.color = "white";
            setTimeout(() => el.style.color = "var(--pink-soft)", 300);
        }
    </script>
</body>
</html>
