<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÄ Impostor: Pink Edition Ultimate</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* PALETA COQUETTE PRO */
            --bg-gradient: linear-gradient(135deg, #2b111b 0%, #4a192c 100%);
            --card-glass: rgba(255, 255, 255, 0.08);
            --border-glass: rgba(255, 192, 203, 0.3);
            --neon-pink: #ff69b4;
            --soft-pink: #ffb7c5;
            --deep-rose: #d63384;
            --text-white: #fff0f5;
            --text-muted: #e6ccd6;
            --shadow-glow: 0 0 20px rgba(255, 105, 180, 0.4);
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-white);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><text y="18" font-size="18">üéÄ</text></svg>'), auto;
        }

        /* FONDO ANIMADO */
        .bg-particles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1;
        }
        .particle {
            position: absolute; border-radius: 50%;
            background: radial-gradient(circle, var(--neon-pink), transparent);
            opacity: 0.3; animation: floatUp linear infinite;
        }
        .bg-emoji {
            position: absolute; font-size: 2rem; opacity: 0.2;
            animation: floatEmoji linear infinite; filter: blur(1px);
        }

        @keyframes floatUp { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: translateY(-10vh) scale(1); opacity: 0; } }
        @keyframes floatEmoji { 0% { transform: translateY(110vh) rotate(0deg); } 100% { transform: translateY(-10vh) rotate(360deg); } }

        /* T√çTULO PRINCIPAL */
        h1 {
            font-family: 'Dancing Script', cursive; font-size: 4.5rem;
            background: linear-gradient(to right, #ff9a9e, #fecfef, #ff9a9e);
            -webkit-background-clip: text; color: transparent;
            margin: 10px 0; filter: drop-shadow(0 0 10px rgba(255,105,180,0.6));
            animation: shimmer 3s infinite linear;
        }
        @keyframes shimmer { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }

        /* CONTENEDOR DE CRISTAL (GLASSMORPHISM) */
        .glass-panel {
            background: var(--card-glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 30px;
            padding: 3rem;
            width: 100%; max-width: 600px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.05);
            text-align: center; position: relative; overflow: hidden;
            margin-top: 20px;
        }

        /* DECORACI√ìN BRILLANTE */
        .glass-panel::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,192,203,0.1) 0%, transparent 60%);
            animation: rotateBg 10s linear infinite; pointer-events: none;
        }
        @keyframes rotateBg { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* INPUTS */
        input {
            width: 100%; padding: 18px; margin: 15px 0;
            background: rgba(0,0,0,0.4); border: 2px solid var(--border-glass);
            border-radius: 20px; color: var(--text-white); font-size: 1.1rem;
            text-align: center; font-family: 'Quicksand'; outline: none;
        }
        input:focus {
            border-color: var(--neon-pink); background: rgba(0,0,0,0.6);
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.3); transform: scale(1.02);
        }

        /* BOTONES PRO */
        button {
            width: 100%; padding: 18px; margin-top: 20px;
            background: linear-gradient(45deg, #ff00cc, #333399); /* Placeholder gradient, overwritten below */
            background: linear-gradient(135deg, var(--deep-rose) 0%, var(--neon-pink) 100%);
            border: none; border-radius: 20px; color: white;
            font-weight: 700; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 10px 30px rgba(214, 51, 132, 0.4);
            position: relative; overflow: hidden; letter-spacing: 1px;
        }
        button::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(214, 51, 132, 0.6); }
        button:hover::after { left: 100%; }

        button.secondary {
            background: transparent; border: 2px solid var(--soft-pink);
            color: var(--soft-pink); box-shadow: none;
        }
        button.secondary:hover { background: rgba(255,183,197,0.1); color: white; border-color: white; }

        button.danger { background: linear-gradient(135deg, #ff416c, #ff4b2b); }

        /* UTILIDADES */
        .hidden { display: none !important; opacity: 0; }
        
        /* LISTAS */
        .player-list li {
            background: rgba(255,255,255,0.05); margin: 10px 0; padding: 15px;
            border-radius: 15px; display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid var(--neon-pink);
            backdrop-filter: blur(5px);
        }

        /* TARJETA DE ROL */
        .role-container {
            border: 2px dashed var(--border-glass); padding: 30px; border-radius: 25px;
            background: rgba(0,0,0,0.2); position: relative;
        }
        
        .secret-word {
            font-family: 'Dancing Script', cursive; font-size: 3.5rem;
            color: var(--soft-pink); text-shadow: 0 0 20px var(--deep-rose);
            margin: 20px 0; line-height: 1;
        }

        .desc-box {
            font-size: 1rem; color: var(--text-muted); background: rgba(0,0,0,0.3);
            padding: 20px; border-radius: 15px; font-style: italic;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .impostor-alert {
            font-size: 3rem; color: #ff416c; font-family: 'Dancing Script';
            text-shadow: 0 0 30px #ff416c; animation: heartbeat 1.5s infinite;
        }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.1); } 30% { transform: scale(1); } }

        /* COPY CODE */
        #roomIdDisplay {
            font-family: monospace; font-size: 1.5rem; color: var(--neon-pink);
            background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px;
            cursor: pointer; display: inline-block; border: 1px dashed var(--neon-pink);
        }
        #roomIdDisplay:hover { background: var(--neon-pink); color: white; }

        .kick-btn { width: auto; margin:0; padding: 5px 12px; font-size: 0.8rem; background: transparent; border: 1px solid #ff416c; color: #ff416c; box-shadow: none; }
        .kick-btn:hover { background: #ff416c; color: white; }

    </style>
</head>
<body>

    <div id="particles" class="bg-particles"></div>

    <h1>The Impostor</h1>
    <div style="font-size: 0.9rem; letter-spacing: 3px; color: var(--soft-pink); text-transform: uppercase; margin-bottom: 20px;">
        ‚ú® Pink Pro Edition ‚ú®
    </div>
    <div id="statusMsg" style="color: var(--text-muted); height: 20px; font-size: 0.9rem;"></div>

    <div id="screen-menu" class="glass-panel">
        <h2 style="font-family:'Dancing Script'; font-size: 2.5rem; color: var(--soft-pink);">Login üíñ</h2>
        <input type="text" id="myUsername" placeholder="Tu nombre..." maxlength="12">
        <button onclick="createGame()">Crear Sala üéÄ</button>
        <div style="margin: 20px 0; color: var(--text-muted); font-size: 0.9rem;">‚Äî o √∫nete a tus besties ‚Äî</div>
        <input type="text" id="joinInput" placeholder="C√≥digo de sala">
        <button class="secondary" onclick="joinGame()">Unirse ‚ú®</button>
    </div>

    <div id="screen-lobby" class="glass-panel hidden">
        <h2 style="font-family:'Dancing Script'; font-size: 2.5rem;">Lobby üß∏</h2>
        <p style="color: var(--text-muted);">Toca para copiar el c√≥digo:</p>
        <div id="roomIdDisplay" onclick="copyRoomCode()">Cargando...</div>

        <h3 style="margin-top: 30px; text-align: left; color: var(--soft-pink);">Jugadoras (<span id="playerCount">0</span>)</h3>
        <ul id="lobbyList" class="player-list" style="padding:0; list-style:none;"></ul>

        <div id="hostControls" class="hidden" style="margin-top: 30px;">
            <button onclick="startGame()" id="btnStart">üíñ Empezar Partida üíñ</button>
        </div>
        <div id="clientWaiting" class="hidden">
            <p style="color: var(--neon-pink); font-weight: bold; margin-top: 20px;">Esperando a la Host... üíÖ</p>
        </div>
    </div>

    <div id="screen-game" class="glass-panel hidden">
        <div class="role-container">
            <p style="color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem;">Tu Identidad Secreta</p>
            <h3 id="roleDisplay" style="font-family: 'Dancing Script'; font-size: 2.5rem; margin: 10px 0; color: white;">...</h3>
            
            <div id="wordContainer">
                <hr style="border: 0; border-top: 1px dashed var(--border-glass); margin: 20px 0;">
                <p style="font-size:0.9rem; color: var(--text-muted);">LA PALABRA ES:</p>
                <div id="secretWordDisplay" class="secret-word">???</div>
                <div id="secretDescDisplay" class="desc-box">Cargando definici√≥n...</div>
            </div>
            
            <div id="impostorMessage" class="hidden">
                <hr style="border: 0; border-top: 1px dashed var(--border-glass); margin: 20px 0;">
                <div class="impostor-alert">IMPOSTORA</div>
                <p style="color: var(--text-white); font-size: 1.1rem;">Shhh... ü§´<br>Miente como nunca.</p>
            </div>
        </div>

        <div style="margin-top: 25px; text-align: left;">
            <p style="color: var(--neon-pink); font-weight: bold;">ü©∞ Orden de Turnos:</p>
            <ol id="turnOrderList" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; color: var(--text-muted);"></ol>
        </div>
        
        <div id="hostGameControls" class="hidden" style="margin-top: 20px;">
            <button class="danger" onclick="revealGame()">üíî Terminar Ronda</button>
        </div>
        <p id="waitingReveal" class="hidden" style="margin-top:20px; color: var(--text-muted);">Jugando... ‚ú®</p>
    </div>

    <div id="screen-result" class="glass-panel hidden">
        <h2 style="font-family: 'Dancing Script'; font-size: 3rem; color: var(--soft-pink);">Resultados</h2>
        
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; margin-bottom: 25px;">
            <p style="color: var(--text-muted); font-size: 0.9rem;">La palabra era:</p>
            <div id="finalWord" style="font-size: 2.5rem; color: var(--neon-pink); font-family: 'Dancing Script'; font-weight: bold;"></div>
            <p id="finalDesc" style="font-size: 0.9rem; color: var(--text-muted); font-style: italic;"></p>
        </div>

        <p style="color: var(--text-muted);">La Impostora era:</p>
        <h3 id="finalImpostor" style="font-family: 'Dancing Script'; font-size: 3rem; color: #ff416c; margin: 0;"></h3>
        
        <div id="hostRestartControls" class="hidden">
            <button onclick="returnToLobby()">üîÑ Volver al Lobby</button>
        </div>
        <p id="clientRestartWaiting" class="hidden" style="color: var(--text-muted); margin-top:20px;">Esperando al Host...</p>
    </div>

    <script>
        // --- GENERACI√ìN DE PART√çCULAS Y EMOJIS ---
        const particleContainer = document.getElementById('particles');
        const emojis = ["üéÄ", "ü¶¢", "ü©∞", "üíÑ", "üßÅ", "üß∏", "üíñ", "üçì", "üïØÔ∏è", "üíå", "üíÖ", "‚ú®"];
        
        // Emojis flotantes
        for(let i=0; i<15; i++) {
            const el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'bg-emoji';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.animationDuration = (Math.random() * 20 + 20) + 's';
            el.style.animationDelay = Math.random() * 10 + 's';
            particleContainer.appendChild(el);
        }
        // Part√≠culas (polvo de hadas)
        for(let i=0; i<30; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const size = Math.random() * 5 + 2 + 'px';
            p.style.width = size; p.style.height = size;
            p.style.left = Math.random() * 100 + 'vw';
            p.style.animationDuration = (Math.random() * 10 + 5) + 's';
            p.style.animationDelay = Math.random() * 5 + 's';
            particleContainer.appendChild(p);
        }

        // --- DATABASE DE JUEGO (TU LISTA) ---
        const PALABRAS_JUEGO = [
            "Perro", "Gato", "Hamster", "Conejo", "Loro", "P√°jaro", "√Åguila", "B√∫ho", "Ping√ºino", "Pato", "Gallina", "Gallo", "Vaca", "Cerdo", "Oveja", "Caballo", "Burro", "Cabra", "Le√≥n", "Tigre", "Leopardo", "Pantera", "Elefante", "Jirafa", "Rinoceronte", "Hipop√≥tamo", "Cebra", "Oso", "Oso Panda", "Oso Polar", "Koala", "Canguro", "Mono", "Gorila", "Chimpanc√©", "Lobo", "Zorro", "Ciervo", "Ardilla", "Rat√≥n", "Rata", "Murci√©lago", "Ballena", "Delf√≠n", "Tibur√≥n", "Pulpo", "Cangrejo", "Tortuga", "Cocodrilo", "Serpiente", "Cobra", "Rana", "Sapo", "Camale√≥n", "Iguana", "Dinosaurio", "T-Rex", "Drag√≥n", "Unicornio", "Mariposa", "Abeja", "Hormiga", "Ara√±a", "Mosquito", "Mosca", "Cucaracha", "Escorpi√≥n", "Caracol", "Medusa", "Estrella de Mar", "Pez Payaso", "Salm√≥n", "Flamenco", "Cisne", "Pavo Real", "Capibara", "Nutria", "Erizo",
            "M√≥vil", "iPhone", "Cargador", "Auriculares", "Ordenador", "Port√°til", "Tablet", "Teclado", "Rat√≥n", "Pantalla", "Televisi√≥n", "Mando a distancia", "C√°mara", "Reloj", "Despertador", "L√°mpara", "Bombilla", "Linterna", "Vela", "Mechero", "Caja", "Maleta", "Mochila", "Bolso", "Cartera", "Llaves", "Llavero", "Gafas", "Gafas de Sol", "Paraguas", "Mesa", "Silla", "Sof√°", "Sill√≥n", "Cama", "Almohada", "Manta", "S√°bana", "Espejo", "Peine", "Cepillo de dientes", "Pasta de dientes", "Jab√≥n", "Champ√∫", "Toalla", "Papel Higi√©nico", "Escoba", "Fregona", "Cubo", "Basura", "Lavadora", "Nevera", "Microondas", "Horno", "Sart√©n", "Olla", "Plato", "Vaso", "Taza", "Cuchillo", "Tenedor", "Cuchara", "Botella", "Servilleta", "Libro", "Cuaderno", "Bol√≠grafo", "L√°piz", "Goma de borrar", "Tijeras", "Pegamento", "Regla", "Papel", "Carta", "Sobre", "Sello", "Peri√≥dico", "Revista", "Mapa", "Bandera", "Moneda", "Billete", "Tarjeta de Cr√©dito", "Anillo", "Collar", "Pendientes", "Pulsera", "Reloj de pulsera",
            "Star Wars", "Darth Vader", "Yoda", "Luke Skywalker", "Princesa Leia", "Sable de Luz", "Harry Potter", "Hermione", "Ron Weasley", "Voldemort", "Varita M√°gica", "Hogwarts", "El Se√±or de los Anillos", "Frodo", "Gandalf", "Gollum", "Anillo", "Marvel", "Avengers", "Iron Man", "Spiderman", "Capit√°n Am√©rica", "Thor", "Hulk", "Thanos", "Batman", "Joker", "Superman", "Wonder Woman", "Disney", "Mickey Mouse", "Minnie", "Pato Donald", "Rey Le√≥n", "Simba", "Frozen", "Elsa", "Olaf", "Toy Story", "Woody", "Buzz Lightyear", "Shrek", "Burro", "Fiona", "Minions", "Gru", "Piratas del Caribe", "Jack Sparrow", "Titanic", "Barco", "Avatar", "Azul", "Jurassic Park", "T-Rex", "Stranger Things", "Once (Eleven)", "Mi√©rcoles (Wednesday)", "La Casa de Papel", "M√°scara de Dal√≠", "El Juego del Calamar", "Friends", "Juego de Tronos", "Drag√≥n", "Jon Snow", "Breaking Bad", "Los Simpson", "Homer Simpson", "Barbie", "Ken", "Oppenheimer", "Bomba", "Cine", "Pel√≠cula", "Palomitas", "Netflix", "Hollywood", "Oscar", "Actor", "Actriz", "Director",
            "Brad Pitt", "Leonardo DiCaprio", "Tom Cruise", "Johnny Depp", "Will Smith", "Angelina Jolie", "Jennifer Lawrence", "Emma Watson", "Zendaya", "Tom Holland", "Chris Hemsworth", "Dwayne Johnson (The Rock)", "Marilyn Monroe", "Elvis Presley", "Michael Jackson", "Freddie Mercury", "Madonna", "Shakira", "Beyonc√©", "Rihanna", "Taylor Swift", "Lady Gaga", "Ariana Grande", "Justin Bieber", "Selena Gomez", "Miley Cyrus", "Harry Styles", "Bad Bunny", "Rosal√≠a", "Karol G", "Daddy Yankee", "Eminem", "Bizarrap", "BTS",
            "Super Mario", "Luigi", "Princesa Peach", "Mario Kart", "Nintendo", "PlayStation", "Xbox", "Fortnite", "Minecraft", "Bloque", "Pico", "Espada", "Zelda", "Link", "Pok√©mon", "Pikachu", "Pok√©ball", "Charizard", "Among Us", "Impostor", "Tripulante", "GTA", "Coches", "FIFA", "F√∫tbol", "Call of Duty", "Disparos", "League of Legends", "Roblox", "Pac-Man", "Tetris", "Sonic", "Erizo", "Mando", "Consola", "Ordenador Gamer", "Streamer", "Youtuber", "Twitch", "Lag", "Game Over", "Nivel", "Vida", "Jefe Final",
            "F√∫tbol", "Bal√≥n", "Porter√≠a", "Gol", "√Årbitro", "Tarjeta Roja", "Penalti", "Lionel Messi", "Cristiano Ronaldo", "Neymar", "Mbapp√©", "Haaland", "Sergio Ramos", "Piqu√©", "Iniesta", "Maradona", "Pel√©", "Real Madrid", "Bar√ßa", "M√°laga CF", "Baloncesto", "Canasta", "Michael Jordan", "LeBron James", "Kobe Bryant", "Pau Gasol", "NBA", "Tenis", "Raqueta", "Rafa Nadal", "Roger Federer", "Djokovic", "Alcaraz", "F√≥rmula 1", "Coche de carreras", "Fernando Alonso", "Lewis Hamilton", "Ferrari", "MotoGP", "Moto", "Marc M√°rquez", "Valentino Rossi", "Nataci√≥n", "Piscina", "Atletismo", "Correr", "Juegos Ol√≠mpicos", "Medalla de Oro", "Gimnasio", "Boxeo", "Ring", "Guantes",
            "Ciudad", "Pueblo", "Playa", "Mar", "Monta√±a", "Bosque", "Selva", "Desierto", "Isla", "Volc√°n", "Cueva", "R√≠o", "Lago", "Cascada", "Parque", "Jard√≠n", "Granja", "Zool√≥gico", "Escuela", "Hospital", "Aeropuerto", "Estaci√≥n de tren", "Restaurante", "Hotel", "Supermercado", "Centro Comercial", "Cine", "Museo", "Iglesia", "Cementerio", "Castillo", "Palacio", "Casa", "Edificio", "Rascacielos", "Puente", "Carretera", "Espa√±a", "Madrid", "Barcelona", "M√°laga", "Par√≠s", "Torre Eiffel", "Londres", "Big Ben", "Nueva York", "Estatua de la Libertad", "Roma", "Coliseo", "Egipto", "Pir√°mides", "China", "Muralla China", "Jap√≥n", "Tokio", "Polo Norte", "Espacio", "Luna", "Sol", "Estrellas", "Planeta", "Tierra",
            "Pizza", "Hamburguesa", "Patatas Fritas", "Hot Dog", "Sandwich", "Bocadillo", "Ensalada", "Sopa", "Arroz", "Pasta", "Espaguetis", "Macarrones", "Huevo", "Huevo Frito", "Tortilla", "Pollo", "Carne", "Pescado", "Sushi", "Tacos", "Burrito", "Pan", "Queso", "Jam√≥n", "Fruta", "Manzana", "Pl√°tano", "Naranja", "Fresa", "Uvas", "Sand√≠a", "Mel√≥n", "Pi√±a", "Lim√≥n", "Tomate", "Lechuga", "Patata", "Zanahoria", "Cebolla", "Ajo", "Sal", "Az√∫car", "Pimienta", "Aceite", "Chocolate", "Helado", "Tarta", "Pastel", "Galleta", "Donut", "Cruas√°n", "Yogur", "Leche", "Agua", "Zumo", "Refresco", "Coca-Cola", "Caf√©", "T√©", "Cerveza", "Vino",
            "Camiseta", "Pantalones", "Vaqueros", "Vestido", "Falda", "Jersey", "Sudadera", "Abrigo", "Chaqueta", "Camisa", "Traje", "Corbata", "Pijama", "Ropa Interior", "Calcetines", "Zapatos", "Zapatillas", "Deportivas", "Botas", "Tacones", "Sandalias", "Chanclas", "Gorro", "Sombrero", "Gorra", "Bufanda", "Guantes", "Ba√±ador", "Bikini", "Cintur√≥n", "Disfraz", "Maquillaje", "Pintalabios", "Perfume", "Colonia",
            "Guitarra", "Piano", "Viol√≠n", "Bater√≠a", "Trompeta", "Saxof√≥n", "Flauta", "Tambor", "Micr√≥fono", "M√∫sica", "Canci√≥n", "Cantante", "Bailar√≠n", "Baile", "Pintura", "Cuadro", "Pincel", "Color", "Escultura", "Teatro", "Circo", "Mago", "Payaso",
            "Coche", "Moto", "Bicicleta", "Patinete", "Autob√∫s", "Taxi", "Tren", "Metro", "Avi√≥n", "Helic√≥ptero", "Barco", "Crucero", "Submarino", "Cami√≥n", "Furgoneta", "Tractor", "Ambulancia", "Coche de Polic√≠a", "Cami√≥n de Bomberos", "Cohete", "Ovni",
            "M√©dico", "Enfermera", "Polic√≠a", "Bombero", "Profesor", "Estudiante", "Cocinero", "Camarero", "Peluquero", "Astronauta", "Piloto", "Soldado", "Rey", "Reina", "Princesa", "Pr√≠ncipe", "Pirata", "Ninja", "Vampiro", "Zombi", "Fantasma", "Bruja", "Hada", "Sirena", "Robot", "Alien", "Amor", "Odio", "Miedo", "Alegr√≠a", "Tristeza", "Suerte", "Tiempo", "Vida", "Muerte", "Boda", "Cumplea√±os", "Navidad", "Halloween", "Verano", "Invierno", "Fr√≠o", "Calor", "Lluvia", "Nieve", "Viento", "Tormenta", "Arcoiris", "Fuego", "Humo", "Luz", "Oscuridad", "Sombra", "Sue√±o", "Pesadilla", "Dinero", "Trabajo", "Fiesta", "Vacaciones", "Regalo", "Sorpresa"
        ];

        // --- L√ìGICA DE JUEGO & CONEXI√ìN ---
        let peer = null;
        let connections = [];
        let isHost = false;
        let myName = "";
        let players = []; 
        let gameState = {}; 

        const screens = ['menu', 'lobby', 'game', 'result'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
            document.getElementById(`screen-${name}`).classList.remove('hidden');
            setTimeout(() => document.getElementById(`screen-${name}`).style.opacity = '1', 10);
        }
        function updateStatus(msg) { document.getElementById('statusMsg').innerText = msg; }

        async function getWordAndDescription() {
            const rawWord = PALABRAS_JUEGO[Math.floor(Math.random() * PALABRAS_JUEGO.length)];
            
            // Buscar descripci√≥n en Wikipedia
            const url = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&exchars=280&titles=${encodeURIComponent(rawWord)}&format=json&origin=*`;
            
            let description = "Un concepto muy conocido."; // Fallback

            try {
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId !== "-1") {
                    const extract = pages[pageId].extract;
                    if (extract && extract.length > 5) {
                        description = extract.split('.')[0] + ".";
                        if(description.length > 200) description = description.substring(0, 200) + "...";
                    }
                }
            } catch (e) {
                console.log("Wiki fetch failed, using fallback.");
            }

            return { title: rawWord, desc: description };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- PEERJS ---
        function createGame() {
            myName = document.getElementById('myUsername').value.trim() || "Diva";
            isHost = true;
            updateStatus("Abriendo portal m√°gico...");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                document.getElementById('roomIdDisplay').innerText = id;
                updateStatus("");
                players = [{ id: id, name: myName, isHost: true }];
                updateLobbyUI();
                showScreen('lobby');
                document.getElementById('hostControls').classList.remove('hidden');
            });

            peer.on('connection', (c) => {
                c.on('open', () => { c.on('data', (d) => handleDataHost(d, c)); });
                c.on('close', () => {
                    players = players.filter(p => p.id !== c.peer);
                    connections = connections.filter(con => con.peer !== c.peer);
                    broadcastLobby();
                });
            });
        }

        function joinGame() {
            myName = document.getElementById('myUsername').value.trim() || "Princess";
            const roomId = document.getElementById('joinInput').value.trim();
            if (!roomId) return alert("¬°Necesitas el c√≥digo, amiga! ü¶¢");
            
            isHost = false;
            updateStatus("Conectando...");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                const conn = peer.connect(roomId);
                conn.on('open', () => {
                    updateStatus("Conectada");
                    conn.send({ type: 'JOIN', name: myName, id: id });
                    connections = [conn]; 
                });
                conn.on('data', (d) => handleDataClient(d));
                conn.on('close', () => { alert("Ups, se cerr√≥ la sala."); location.reload(); });
            });
        }

        function handleDataHost(data, connSource) {
            if (data.type === 'JOIN') {
                if (!players.find(p => p.id === data.id)) {
                    connections.push(connSource);
                    players.push({ id: data.id, name: data.name });
                    broadcastLobby();
                }
            }
        }

        function handleDataClient(data) {
            if (data.type === 'LOBBY') {
                players = data.players;
                showScreen('lobby');
                updateLobbyUI();
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('clientWaiting').classList.remove('hidden');
            }
            if (data.type === 'START') setupGame(data.wordData, data.impostor, data.order);
            if (data.type === 'REVEAL') showResult(data.wordData, data.impostorName);
            if (data.type === 'RESET') showScreen('lobby');
        }

        function broadcastLobby() {
            const safePlayers = players.map(p => ({ id: p.id, name: p.name, isHost: p.isHost }));
            const msg = { type: 'LOBBY', players: safePlayers };
            if (!isHost) return;
            updateLobbyUI();
            connections.forEach(c => c.send(msg));
        }

        async function startGame() {
            if (players.length < 3 && !confirm("¬øMenos de 3 jugadoras? ¬°Ser√° dif√≠cil!")) return;
            
            const btn = document.getElementById('btnStart');
            btn.innerText = "‚ú® Escaneando el universo... ‚ú®";
            btn.disabled = true;

            const wordData = await getWordAndDescription();
            
            const impostor = players[Math.floor(Math.random() * players.length)];
            let turnOrder = [...players];
            turnOrder = shuffleArray(turnOrder).map(p => p.name);

            gameState = { wordData: wordData, impostorName: impostor.name };
            
            const msg = { 
                type: 'START', 
                wordData: wordData, 
                impostor: impostor.id,
                order: turnOrder
            };
            
            connections.forEach(c => c.send(msg));
            setupGame(wordData, impostor.id, turnOrder);

            btn.innerText = "üíñ Empezar Partida üíñ";
            btn.disabled = false;
        }

        function setupGame(wordData, impostorId, orderList) {
            showScreen('game');
            const amIImpostor = (peer.id === impostorId);
            
            const roleTxt = document.getElementById('roleDisplay');
            if (amIImpostor) {
                roleTxt.innerText = "üíî IMPOSTORA";
                roleTxt.style.color = "#ff4d6d";
                roleTxt.style.textShadow = "0 0 15px #ff4d6d";
                document.getElementById('wordContainer').classList.add('hidden');
                document.getElementById('impostorMessage').classList.remove('hidden');
            } else {
                roleTxt.innerText = "üíñ CIUDADANA";
                roleTxt.style.color = "#ffb7c5";
                roleTxt.style.textShadow = "0 0 15px #ffb7c5";
                document.getElementById('wordContainer').classList.remove('hidden');
                document.getElementById('impostorMessage').classList.add('hidden');
                
                document.getElementById('secretWordDisplay').innerText = wordData.title;
                document.getElementById('secretDescDisplay').innerText = wordData.desc;
            }

            const ul = document.getElementById('turnOrderList');
            ul.innerHTML = '';
            orderList.forEach((name, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span><span style='opacity:0.6'>${index + 1}.</span> ${name}</span>`;
                li.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
                li.style.padding = "5px 0";
                ul.appendChild(li);
            });

            if (isHost) {
                document.getElementById('hostGameControls').classList.remove('hidden');
                document.getElementById('waitingReveal').classList.add('hidden');
            } else {
                document.getElementById('hostGameControls').classList.add('hidden');
                document.getElementById('waitingReveal').classList.remove('hidden');
            }
        }

        function revealGame() {
            const msg = { type: 'REVEAL', wordData: gameState.wordData, impostorName: gameState.impostorName };
            connections.forEach(c => c.send(msg));
            showResult(msg.wordData, msg.impostorName);
        }

        function showResult(wordData, impostorName) {
            showScreen('result');
            document.getElementById('finalWord').innerText = wordData.title;
            document.getElementById('finalDesc').innerText = wordData.desc;
            document.getElementById('finalImpostor').innerText = impostorName;
            
            if(isHost) {
                document.getElementById('hostRestartControls').classList.remove('hidden');
                document.getElementById('clientRestartWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostRestartControls').classList.add('hidden');
                document.getElementById('clientRestartWaiting').classList.remove('hidden');
            }
        }

        function returnToLobby() {
            broadcastLobby();
            connections.forEach(c => c.send({ type: 'RESET' }));
            showScreen('lobby');
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobbyList');
            list.innerHTML = '';
            document.getElementById('playerCount').innerText = players.length;
            players.forEach(p => {
                const li = document.createElement('li');
                let html = `<span>${p.name} ${p.isHost ? 'üëë' : ''}</span>`;
                if(isHost && p.id !== peer.id) {
                    html += `<button class="kick-btn" onclick="kickPlayer('${p.id}')">Bye</button>`;
                }
                li.innerHTML = html;
                list.appendChild(li);
            });
        }
        
        function kickPlayer(id) {
            if(!confirm("¬øSacar de la sala?")) return;
            const conn = connections.find(c => c.peer === id);
            if (conn) conn.close();
            players = players.filter(p => p.id !== id);
            connections = connections.filter(c => c.peer !== id);
            broadcastLobby();
        }

        function copyRoomCode() {
            const el = document.getElementById('roomIdDisplay');
            const text = el.innerText;
            if(text === "Cargando...") return;
            navigator.clipboard.writeText(text);
            el.style.borderColor = "#fff";
            el.style.color = "#fff";
            setTimeout(() => {
                el.style.borderColor = "var(--neon-pink)";
                el.style.color = "var(--neon-pink)";
            }, 300);
        }
    </script>
</body>
</html>
