<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Impostor Malaguista PRO</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --mcf-sky: #6CABDD;
            --mcf-dark: #0a2c5c;
            --mcf-gold: #D4AF37;
            --white: #ffffff;
            --danger: #ff4757;
            --pitch-green: #2ecc71;
            --pitch-dark: #27ae60;
            --glass-bg: rgba(255, 255, 255, 0.96);
            --shadow-soft: 0 15px 50px rgba(0, 20, 60, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: #2d3436;
            overflow-x: hidden; background-color: #001433;
        }

        /* FONDO ANIMADO */
        .bg-layer-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg/1200px-Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg') no-repeat center center fixed;
            background-size: cover; z-index: -5; 
            filter: grayscale(30%) contrast(110%);
            animation: subtleZoom 60s infinite alternate;
        }
        .bg-layer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(10, 44, 92, 0.9), rgba(108, 171, 221, 0.8));
            z-index: -4;
        }
        @keyframes subtleZoom { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }

        /* EMOJIS FLOTANTES */
        .emoji-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
        .floating-emoji { position: absolute; animation: floatAround linear infinite; z-index: 0; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        @keyframes floatAround {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(20px, -40px) rotate(180deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }

        /* CABECERA */
        header { text-align: center; margin-bottom: 20px; z-index: 10; position: relative; }
        .shield { width: 90px; height: auto; margin-bottom: 10px; filter: drop-shadow(0 0 20px rgba(255,255,255,0.6)); animation: breathe 4s ease-in-out infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        h1 { font-family: 'Teko', sans-serif; font-size: 3.5rem; margin: 0; line-height: 0.85; color: var(--white); text-shadow: 0 5px 15px rgba(0,0,0,0.3); letter-spacing: 1px; }
        
        .badge-pro { 
            background: var(--mcf-gold); color: var(--mcf-dark); 
            padding: 5px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 900; 
            letter-spacing: 2px; text-transform: uppercase; display: inline-block; margin-top: 10px; 
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4); 
        }

        /* CONTENEDOR PRINCIPAL */
        .main-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            width: 100%; max-width: 1000px;
            border-radius: 25px; padding: 30px;
            box-shadow: var(--shadow-soft);
            text-align: center; position: relative; z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* CAMPO DE F√öTBOL (PITCH) */
        .football-pitch {
            background: 
                repeating-linear-gradient(0deg, var(--pitch-green), var(--pitch-green) 25px, var(--pitch-dark) 25px, var(--pitch-dark) 50px);
            border: 4px solid white;
            border-radius: 10px;
            position: relative;
            width: 100%;
            height: 650px; 
            margin: 20px 0;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .pitch-line-center { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.6); }
        .pitch-circle { 
            position: absolute; top: 50%; left: 50%; width: 100px; height: 100px; 
            border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; transform: translate(-50%, -50%); 
        }
        .pitch-area-top { 
            position: absolute; top: 0; left: 50%; width: 200px; height: 80px; 
            border: 2px solid rgba(255,255,255,0.6); border-top: none; transform: translateX(-50%); background: rgba(255,255,255,0.1);
        }
        .pitch-area-bottom { 
            position: absolute; bottom: 0; left: 50%; width: 200px; height: 80px; 
            border: 2px solid rgba(255,255,255,0.6); border-bottom: none; transform: translateX(-50%); background: rgba(255,255,255,0.1);
        }

        /* JUGADOR EN EL CAMPO */
        .pitch-player {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 80px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .kit-shirt {
            font-size: 2.5rem; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
            transition: transform 0.2s;
        }
        .pitch-player:hover .kit-shirt { transform: scale(1.2); }
        
        .player-tag {
            background: rgba(255,255,255,0.95); color: var(--mcf-dark);
            padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 800;
            white-space: nowrap; margin-top: -5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 120px; overflow: hidden; text-overflow: ellipsis;
        }
        .position-tag {
            background: var(--mcf-dark); color: var(--mcf-gold);
            font-size: 0.6rem; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;
        }
        .host-mark { color: var(--mcf-sky); margin-left: 3px; }

        /* UI ELEMENTS */
        input {
            width: 100%; padding: 20px; margin: 15px 0;
            background: #f1f5f9; border: 2px solid #cbd5e1;
            border-radius: 16px; color: var(--mcf-dark);
            font-family: 'Montserrat'; font-weight: 700; font-size: 1.2rem;
            text-align: center; outline: none; transition: all 0.3s;
        }
        input:focus { border-color: var(--mcf-sky); background: var(--white); box-shadow: 0 0 0 4px rgba(108, 171, 221, 0.3); }

        button {
            width: 100%; padding: 20px; margin-top: 15px;
            background: linear-gradient(135deg, var(--mcf-sky) 0%, var(--mcf-dark) 100%);
            color: var(--white); border: none; border-radius: 16px;
            font-family: 'Teko', sans-serif; font-size: 1.8rem; letter-spacing: 1px;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(10, 44, 92, 0.3);
            position: relative; overflow: hidden; transition: all 0.2s;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(10, 44, 92, 0.5); filter: brightness(1.1); }
        button:active { transform: scale(0.98); }

        button.secondary { background: transparent; border: 3px solid var(--mcf-dark); color: var(--mcf-dark); box-shadow: none; }
        button.secondary:hover { background: var(--mcf-dark); color: var(--white); }
        button.danger { background: linear-gradient(135deg, #ff6b6b, #ee5253); box-shadow: 0 10px 30px rgba(238, 82, 83, 0.3); }

        .hidden { display: none !important; }

        /* JUEGO */
        .role-container {
            background: linear-gradient(to bottom right, #f8fafc, #f1f5f9);
            border-radius: 20px; padding: 30px; border: 1px solid #e2e8f0; margin-bottom: 30px;
        }
        .label { font-size: 0.8rem; color: #94a3b8; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; display: block; }
        .word-display { font-family: 'Teko'; font-size: 3.5rem; color: var(--mcf-dark); line-height: 1; margin-bottom: 15px; }
        .impostor-display { font-family: 'Teko'; font-size: 4rem; color: var(--danger); line-height: 1; animation: pulse 2s infinite; }

        /* ALINEACI√ìN EN JUEGO */
        .lineup-container { background: var(--mcf-dark); color: white; border-radius: 20px; padding: 5px 0; overflow: hidden; }
        .lineup-row {
            display: flex; align-items: center; padding: 12px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .lineup-row:last-child { border-bottom: none; }
        .dorsal-circle {
            width: 35px; height: 35px; background: rgba(255,255,255,0.15); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Teko'; font-size: 1.3rem; margin-right: 15px; color: var(--mcf-sky);
        }
        .player-turn-name { font-size: 1rem; font-weight: 600; text-align: left; }
        .turn-badge { margin-left: auto; background: var(--mcf-gold); color: var(--mcf-dark); font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; font-weight: 900; }
        .turn-emoji { margin-right: 8px; font-size: 1.1rem; }

        /* COPY CODE */
        #roomIdDisplay {
            font-family: monospace; font-size: 1.5rem; font-weight: 700; color: var(--mcf-dark);
            background: #e2e8f0; padding: 15px; border-radius: 15px; border: 3px dashed #94a3b8;
            cursor: pointer; margin-top: 10px; width: 100%; word-break: break-all; transition: 0.2s;
        }
        #roomIdDisplay:active { transform: scale(0.98); }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 20, 40, 0.85); backdrop-filter: blur(8px);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-box {
            background: var(--white); width: 90%; max-width: 500px;
            border-radius: 25px; padding: 30px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s;
            max-height: 85vh; display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .modal-text { font-size: 1.1rem; font-weight: 500; color: #333; margin-bottom: 20px; line-height: 1.6; overflow-y: auto; text-align: left; padding: 0 10px; }
        .modal-btn-group { display: flex; gap: 10px; justify-content: center; margin-top: auto;}

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="bg-layer-image"></div>
    <div class="bg-layer-overlay"></div>
    <div id="emojiContainer" class="emoji-container"></div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <span id="modalIcon" class="modal-icon">‚öΩ</span>
            <div id="modalMessage" class="modal-text"></div>
            <div id="modalButtons" class="modal-btn-group"></div>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/it/8/80/Malaga_CF.png" alt="M√°laga CF" class="shield">
        <h1>IMPOSTOR<br>MALAGUISTA</h1>
        <div class="badge-pro">‚öΩ LA BOMBONERA EDITION ‚öΩ</div>
    </header>

    <div id="screen-menu" class="main-card">
        <h2 style="font-family:'Teko'; font-size: 2.5rem; margin:0 0 10px 0;">FICHAJE NUEVO ‚úçÔ∏è</h2>
        <input type="text" id="myUsername" placeholder="Tu Nombre de Jugador" maxlength="12">
        <button onclick="createGame()">CREAR VESTUARIO üÜï</button>
        <div style="margin: 20px 0; font-weight: 800; color: #94a3b8; font-size: 0.9rem;">‚Äî O ‚Äî</div>
        <input type="text" id="joinInput" placeholder="C√≥digo del Partido">
        <button class="secondary" onclick="joinGame()">UNIRSE AL EQUIPO ü§ù</button>
    </div>

    <div id="screen-lobby" class="main-card hidden">
        <h2 style="font-family:'Teko'; font-size: 3rem; margin:0;">PIZARRA T√ÅCTICA üìã</h2>
        <p style="color: #64748b;">C√≥digo:</p>
        <div id="roomIdDisplay" onclick="copyRoomCode()">Cargando...</div>

        <div style="margin-top: 20px; text-align: left;">
            <span class="label">ONCE INICIAL (<span id="playerCount">0</span>)</span>
            
            <div id="pitchContainer" class="football-pitch">
                <div class="pitch-area-top"></div>
                <div class="pitch-circle"></div>
                <div class="pitch-line-center"></div>
                <div class="pitch-area-bottom"></div>
                </div>
        </div>

        <div id="hostControls" class="hidden" style="margin-top: 20px;">
            <button onclick="startGame()" id="btnStart">SALTAR AL CAMPO ‚öΩ</button>
        </div>
        <div id="clientWaiting" class="hidden">
            <p style="color: var(--mcf-sky); font-weight: 800; margin-top: 20px; font-size: 1.2rem; animation: pulse 2s infinite;">ESPERANDO AL M√çSTER... ‚è±</p>
        </div>
    </div>

    <div id="screen-game" class="main-card hidden">
        <div class="role-container">
            <span class="label">TU POSICI√ìN T√ÅCTICA üìç</span>
            <div id="roleContent"></div>
        </div>

        <div style="text-align: left;">
            <span class="label" style="margin-bottom: 15px; display:block;">ORDEN DE JUEGO üèÉ‚Äç‚ôÇÔ∏è</span>
            <div id="turnOrderList" class="lineup-container"></div>
        </div>
        
        <div id="hostGameControls" class="hidden" style="margin-top: 20px;">
            <button class="danger" onclick="revealGame()">PITIDO FINAL üõë</button>
        </div>
        <p id="waitingReveal" class="hidden" style="margin-top:20px; color: #94a3b8; font-weight:700;">PARTIDO EN JUEGO... ü§´</p>
    </div>

    <div id="screen-result" class="main-card hidden">
        <h2 style="font-family: 'Teko'; font-size: 3.5rem; color: var(--mcf-dark); margin:0;">MARCADOR üìä</h2>
        
        <div style="background: #f1f5f9; padding: 25px; border-radius: 15px; margin: 25px 0; border: 1px solid #e2e8f0;">
            <span class="label">LA PALABRA CLAVE üîë</span>
            <div id="finalWord" class="word-display" style="font-size: 3rem;"></div>
            <p id="finalDesc" style="font-size: 1rem; color: #475569; font-style: italic; margin-top:10px; line-height:1.4;"></p>
        </div>

        <span class="label">EL INFILTRADO ERA üïµÔ∏è</span>
        <h3 id="finalImpostor" style="font-family: 'Teko'; font-size: 4rem; color: var(--danger); margin: 0; line-height:1;"></h3>
        
        <div id="hostRestartControls" class="hidden">
            <button onclick="returnToLobby()">VOLVER AL VESTUARIO üîÑ</button>
        </div>
        <p id="clientRestartWaiting" class="hidden" style="color: #94a3b8; margin-top:20px; font-weight:600;">RUEDA DE PRENSA...</p>
    </div>

    <script>
        // --- EMOJIS FLOTANTES ---
        const emojiContainer = document.getElementById('emojiContainer');
        const emojis = ["‚öΩ", "üíô", "ü§ç", "üêü", "üåä", "üèüÔ∏è", "üëü", "ü•ò", "üåû", "üå¥", "üèÜ", "ü•á", "ü•Ö", "üéΩ"];
        
        for(let i=0; i<50; i++) {
            let el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'floating-emoji';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.top = Math.random() * 100 + 'vh';
            el.style.fontSize = (Math.random() * 2.5 + 1.5) + 'rem';
            el.style.opacity = (Math.random() * 0.5 + 0.3);
            el.style.animationDuration = (Math.random() * 25 + 15) + 's';
            el.style.animationDelay = (Math.random() * -40) + 's'; 
            emojiContainer.appendChild(el);
        }

        // --- FORMACI√ìN T√ÅCTICA (1-4-3-3) ---
        const FORMATION = [
            { name: "PORTERO", x: 50, y: 90 },
            { name: "CENTRAL DCHO", x: 65, y: 75 },
            { name: "CENTRAL IZQ", x: 35, y: 75 },
            { name: "LAT. DCHO", x: 90, y: 65 },
            { name: "LAT. IZQ", x: 10, y: 65 },
            { name: "PIVOTE", x: 50, y: 55 },
            { name: "INTERIOR DCHO", x: 70, y: 45 },
            { name: "INTERIOR IZQ", x: 30, y: 45 },
            { name: "EXT. DCHO", x: 85, y: 20 },
            { name: "EXT. IZQ", x: 15, y: 20 },
            { name: "DELANTERO CENTRO", x: 50, y: 10 },
            // Banquillo
            { name: "SUPLENTE", x: 92, y: 90 }, { name: "SUPLENTE", x: 8, y: 90 },
            { name: "SUPLENTE", x: 92, y: 50 }, { name: "SUPLENTE", x: 8, y: 50 }
        ];

        // --- VAR GLOBAL ---
        let currentWordData = null;

        // --- SISTEMA DE MODALES ---
        function showModal(message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('customModal');
            const icon = document.getElementById('modalIcon');
            const text = document.getElementById('modalMessage');
            const btnGroup = document.getElementById('modalButtons');
            
            text.innerHTML = message;
            btnGroup.innerHTML = '';

            if (type === 'error') icon.innerText = '‚ùå';
            else if (type === 'success') icon.innerText = '‚úÖ';
            else if (type === 'confirm') icon.innerText = '‚ùì';
            else if (type === 'var') icon.innerText = 'üì∫';
            else icon.innerText = '‚öΩ';

            if (type === 'confirm') {
                const btnYes = document.createElement('button');
                btnYes.innerText = "S√ç";
                btnYes.style.flex = "1";
                btnYes.onclick = () => { closeModal(); if(onConfirm) onConfirm(); };
                const btnNo = document.createElement('button');
                btnNo.innerText = "NO";
                btnNo.className = "secondary";
                btnNo.style.flex = "1";
                btnNo.style.marginTop = "0";
                btnNo.onclick = closeModal;
                btnGroup.appendChild(btnNo);
                btnGroup.appendChild(btnYes);
            } else {
                const btnOk = document.createElement('button');
                btnOk.innerText = "ENTENDIDO";
                btnOk.onclick = closeModal;
                btnGroup.appendChild(btnOk);
            }
            modal.classList.add('active');
        }

        function closeModal() { document.getElementById('customModal').classList.remove('active'); }

        // --- DATABASE ---
        const PALABRAS_JUEGO = [
          "Michael Jordan", "LeBron James", "Kobe Bryant", "Shaquille O'Neal", "Stephen Curry", "Magic Johnson", "Larry Bird", "Pau Gasol", "Marc Gasol", "Luka Doncic", "Giannis Antetokounmpo", "Kevin Durant", "James Harden", "Nikola Jokic", "Victor Wembanyama", "Dennis Rodman", "Scottie Pippen", "Kyrie Irving", "Allen Iverson", "Dirk Nowitzki", "Tim Duncan", "Yao Ming", "Steve Nash", "Kareem Abdul-Jabbar", "Wilt Chamberlain", "M√°laga CF", "La Rosaleda", "Isco", "Santi Cazorla", "Dely Vald√©s", "Ruud van Nistelrooy", "Jeremy Toulalan", "Willy Caballero", "Kameni", "Duda", "Weligton", "Julio Baptista", "Joaqu√≠n S√°nchez", "Salom√≥n Rond√≥n", "Camacho", "Sandro Ram√≠rez", "Eliseu", "Manuel Pellegrini", "Basti", "Lionel Messi", "Cristiano Ronaldo", "Diego Maradona", "Pel√©", "Johan Cruyff", "Zinedine Zidane", "Ronaldo Nazario", "Ronaldinho", "Andr√©s Iniesta", "Xavi Hern√°ndez", "Sergio Ramos", "Iker Casillas", "Gerard Piqu√©", "Carles Puyol", "Lamine Yamal", "Jude Bellingham", "Kylian Mbapp√©", "Erling Haaland", "Vinicius Jr", "Neymar", "Luis Su√°rez", "Luka Modric", "Toni Kroos", "David Beckham", "Antoine Griezmann", "Thibaut Courtois", "Oliver y Benji", "Bal√≥n de Oro", "Mundial de F√∫tbol", "Champions League", "√Årbitro", "VAR", "Penalti", "Tarjeta Roja", "Gol", "Porter√≠a", "Darth Vader", "Luke Skywalker", "Princesa Leia", "Yoda", "Han Solo", "Chewbacca", "Harry Potter", "Hermione Granger", "Ron Weasley", "Voldemort", "Dumbledore", "Hogwarts", "Frodo Bols√≥n", "Gandalf", "Gollum", "Sauron", "El Anillo √önico", "Spiderman", "Batman", "Joker", "Superman", "Iron Man", "Capit√°n Am√©rica", "Thor", "Hulk", "Thanos", "Wonder Woman", "Deadpool", "Wolverine", "Mickey Mouse", "Bob Esponja", "Homer Simpson", "Shrek", "Burro", "Fiona", "Buzz Lightyear", "Woody", "Elsa", "Olaf", "Barbie", "Ken", "Jack Sparrow", "Jon Snow", "Daenerys Targaryen", "Walter White", "Eleven", "Mi√©rcoles Addams", "El Profesor", "Super Mario", "Luigi", "Princesa Peach", "Bowser", "Yoshi", "Toad", "Pikachu", "Charizard", "Pok√©ball", "Ash Ketchum", "Sonic", "Link", "Zelda", "Steve", "Creeper", "Kratos", "Master Chief", "Among Us", "Impostor", "Tripulante", "Fortnite", "Minecraft", "Roblox", "League of Legends", "FIFA", "GTA", "Call of Duty", "Tetris", "Pac-Man", "Brad Pitt", "Leonardo DiCaprio", "Tom Cruise", "Will Smith", "Johnny Depp", "Angelina Jolie", "Jennifer Lawrence", "Marilyn Monroe", "Elvis Presley", "Michael Jackson", "Freddie Mercury", "Madonna", "Shakira", "Beyonc√©", "Rihanna", "Taylor Swift", "Lady Gaga", "Rosal√≠a", "Bad Bunny", "Eminem", "Perro", "Gato", "Hamster", "Conejo", "Loro", "Pez", "Tortuga", "Vaca", "Cerdo", "Oveja", "Caballo", "Gallina", "Gallo", "Pato", "Le√≥n", "Tigre", "Elefante", "Jirafa", "Oso", "Panda", "Mono", "Gorila", "Lobo", "Zorro", "√Åguila", "B√∫ho", "Ping√ºino", "Delf√≠n", "Ballena", "Tibur√≥n", "Pulpo", "Cocodrilo", "Serpiente", "Rana", "Dinosaurio", "T-Rex", "Drag√≥n", "Unicornio", "M√≥vil", "iPhone", "Ordenador", "Port√°til", "Televisi√≥n", "Mando", "C√°mara", "Reloj", "L√°mpara", "Bombilla", "Vela", "Mechero", "Caja", "Maleta", "Mochila", "Bolso", "Cartera", "Llaves", "Gafas", "Gafas de sol", "Paraguas", "Mesa", "Silla", "Sof√°", "Cama", "Almohada", "Manta", "Espejo", "Peine", "Cepillo de dientes", "Pasta de dientes", "Jab√≥n", "Champ√∫", "Toalla", "Papel higi√©nico", "Escoba", "Fregona", "Lavadora", "Nevera", "Microondas", "Horno", "Sart√©n", "Olla", "Plato", "Vaso", "Taza", "Cuchillo", "Tenedor", "Cuchara", "Botella", "Libro", "Cuaderno", "Bol√≠grafo", "L√°piz", "Tijeras", "Pegamento", "Mapa", "Bandera", "Moneda", "Billete", "Tarjeta de cr√©dito", "Anillo", "Collar", "Pizza", "Hamburguesa", "Patatas Fritas", "Sushi", "Tacos", "Burrito", "Pasta", "Arroz", "Huevo", "Pan", "Queso", "Chocolate", "Helado", "Tarta", "Fruta", "Manzana", "Pl√°tano", "Naranja", "Fresa", "Sand√≠a", "Leche", "Caf√©", "Cerveza", "Vino", "Coca-Cola", "Agua", "Coche", "Moto", "Bicicleta", "Autob√∫s", "Tren", "Metro", "Avi√≥n", "Barco", "Helic√≥ptero", "Cohete", "M√©dico", "Enfermera", "Polic√≠a", "Bombero", "Profesor", "Cocinero", "Camarero", "Astronauta", "Piloto", "Soldado", "Rey", "Reina", "Pirata", "Ninja", "Vampiro", "Zombi", "Fantasma", "Bruja", "Robot", "Alien", "Amor", "Odio", "Miedo", "Alegr√≠a", "Tristeza", "Suerte", "Tiempo", "Vida", "Muerte", "Boda", "Cumplea√±os", "Navidad", "Halloween", "Verano", "Invierno", "Sol", "Luna", "Lluvia", "Nieve", "Fuego", "Playa", "Monta√±a", "Ciudad", "Bosque", "Desierto", "Isla", "Hospital", "Escuela", "Supermercado", "Cine", "Restaurante", "Aeropuerto", "Parque", "Estadio", "Casa", "Castillo", "Espa√±a", "Madrid", "Barcelona", "M√°laga", "Par√≠s", "Torre Eiffel", "Londres", "Nueva York", "Estatua de la Libertad", "Roma", "Coliseo", "Egipto", "Pir√°mides", "China", "Muralla China", "Jap√≥n", "Espacio"
        ];

        // --- L√ìGICA DE JUEGO ---
        let peer = null;
        let connections = [];
        let isHost = false;
        let myName = "";
        let players = []; 
        let gameState = {}; 

        const screens = ['menu', 'lobby', 'game', 'result'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
            const el = document.getElementById(`screen-${name}`);
            el.classList.remove('hidden');
            el.style.opacity = 0; el.style.transform = "translateY(20px)";
            setTimeout(() => { el.style.opacity = 1; el.style.transform = "translateY(0)"; }, 50);
        }

        async function getWordAndDescription() {
            const rawWord = PALABRAS_JUEGO[Math.floor(Math.random() * PALABRAS_JUEGO.length)];
            const url = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts&exsentences=3&exintro&explaintext&titles=${encodeURIComponent(rawWord)}&format=json&origin=*`;
            
            let description = null;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId !== "-1") {
                    const extract = pages[pageId].extract;
                    if (extract && extract.length > 5) { description = extract; }
                }
            } catch (e) { console.log("Wiki Error", e); }
            return { title: rawWord, desc: description };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ASIGNAR POSICI√ìN ALEATORIA LIBRE
        function getRandomFreePosition(currentPlayers) {
            // √çndices usados
            const usedIndices = currentPlayers.map(p => p.posIndex);
            // √çndices disponibles (0 a FORMATION.length - 1)
            const availableIndices = [];
            for(let i=0; i<FORMATION.length; i++) {
                if(!usedIndices.includes(i)) availableIndices.push(i);
            }
            
            if(availableIndices.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableIndices.length);
                return availableIndices[randomIndex];
            } else {
                // Si no hay hueco (m√°s de 15), usar el √∫ltimo (banquillo compartido)
                return FORMATION.length - 1;
            }
        }

        // --- PEERJS ---
        function createGame() {
            myName = document.getElementById('myUsername').value.trim() || "Malaguista";
            isHost = true;
            showModal("Abriendo vestuario...", "info");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                closeModal();
                document.getElementById('roomIdDisplay').innerText = id;
                // Host asigna su posici√≥n aleatoria
                const posIndex = getRandomFreePosition([]);
                players = [{ id: id, name: myName, isHost: true, posIndex: posIndex }];
                updateLobbyUI();
                showScreen('lobby');
                document.getElementById('hostControls').classList.remove('hidden');
            });

            peer.on('connection', (c) => {
                c.on('open', () => { c.on('data', (d) => handleDataHost(d, c)); });
                c.on('close', () => {
                    players = players.filter(p => p.id !== c.peer);
                    connections = connections.filter(con => con.peer !== c.peer);
                    broadcastLobby();
                });
            });
        }

        function joinGame() {
            myName = document.getElementById('myUsername').value.trim() || "Aficionado";
            const roomId = document.getElementById('joinInput').value.trim();
            if (!roomId) return showModal("¬°Falta el c√≥digo del partido!", "error");
            
            isHost = false;
            showModal("Conectando con el estadio...", "info");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                const conn = peer.connect(roomId);
                conn.on('open', () => {
                    closeModal();
                    conn.send({ type: 'JOIN', name: myName, id: id });
                    connections = [conn]; 
                });
                conn.on('data', (d) => handleDataClient(d));
                conn.on('close', () => { showModal("Se ha perdido la conexi√≥n con el vestuario.", "error"); location.reload(); });
            });
        }

        function handleDataHost(data, connSource) {
            if (data.type === 'JOIN') {
                if (!players.find(p => p.id === data.id)) {
                    connections.push(connSource);
                    // ASIGNAR POSICI√ìN ALEATORIA AL NUEVO
                    const newPosIndex = getRandomFreePosition(players);
                    players.push({ id: data.id, name: data.name, posIndex: newPosIndex });
                    broadcastLobby();
                }
            }
        }

        function handleDataClient(data) {
            if (data.type === 'LOBBY') {
                players = data.players;
                showScreen('lobby');
                updateLobbyUI();
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('clientWaiting').classList.remove('hidden');
            }
            if (data.type === 'START') {
                currentWordData = data.wordData;
                setupGame(data.wordData, data.impostor, data.order);
            }
            if (data.type === 'REVEAL') showResult(data.wordData, data.impostorName);
            if (data.type === 'RESET') showScreen('lobby');
        }

        function broadcastLobby() {
            // Enviar lista limpia con posiciones
            const safePlayers = players.map(p => ({ id: p.id, name: p.name, isHost: p.isHost, posIndex: p.posIndex }));
            const msg = { type: 'LOBBY', players: safePlayers };
            if (!isHost) return;
            updateLobbyUI();
            connections.forEach(c => c.send(msg));
        }

        async function startGame() {
            const btn = document.getElementById('btnStart');
            btn.innerText = "‚è≥ SORTEANDO CAMPO...";
            btn.disabled = true;

            const wordData = await getWordAndDescription();
            const impostor = players[Math.floor(Math.random() * players.length)];
            let turnOrder = [...players];
            turnOrder = shuffleArray(turnOrder).map(p => p.name);

            gameState = { wordData: wordData, impostorName: impostor.name };
            currentWordData = wordData; // Guardar en host tambi√©n
            
            const msg = { 
                type: 'START', 
                wordData: wordData, 
                impostor: impostor.id,
                order: turnOrder
            };
            
            connections.forEach(c => c.send(msg));
            setupGame(wordData, impostor.id, turnOrder);

            btn.innerText = "SALTAR AL CAMPO ‚öΩ";
            btn.disabled = false;
        }

        function setupGame(wordData, impostorId, orderList) {
            showScreen('game');
            const amIImpostor = (peer.id === impostorId);
            const container = document.getElementById('roleContent');
            container.innerHTML = ''; 

            if (amIImpostor) {
                container.innerHTML = `
                    <div class="impostor-display">IMPOSTOR</div>
                    <p style="color: #64748b; font-size: 1.2rem; font-weight:600; margin-top:10px;">Nadie sabe que eres t√∫.<br>Finge, miente y gana.</p>
                `;
            } else {
                let btnHtml = '';
                if (wordData.desc) {
                    btnHtml = `<button class="secondary" style="width:100%; margin-top:20px; font-size:1rem; padding:15px;" onclick="openVarModal()">üìñ CONSULTAR VAR (DEFINICI√ìN)</button>`;
                } else {
                    btnHtml = `<p style="color:#888; font-size:0.9rem; margin-top:15px; font-style:italic;">Sin se√±al de VAR.</p>`;
                }
                container.innerHTML = `<div class="word-display">${wordData.title}</div>${btnHtml}`;
            }

            // ALINEACI√ìN CON EMOJIS
            const turnEmojis = ["ü•Ö", "üß§", "üëü", "üéΩ", "üß¢", "üß£", "üèÅ", "üì¢", "üèüÔ∏è"];
            const listContainer = document.getElementById('turnOrderList');
            listContainer.innerHTML = '';
            orderList.forEach((name, index) => {
                const row = document.createElement('div');
                row.className = 'lineup-row';
                let badge = '';
                if(index === 0) badge = '<span class="turn-badge">SACANDO</span>';
                const randEmoji = turnEmojis[Math.floor(Math.random() * turnEmojis.length)];
                row.innerHTML = `
                    <div class="dorsal-circle">${index + 1}</div>
                    <div class="player-turn-name"><span class="turn-emoji">${randEmoji}</span> ${name}</div>
                    ${badge}
                `;
                listContainer.appendChild(row);
            });

            if (isHost) {
                document.getElementById('hostGameControls').classList.remove('hidden');
                document.getElementById('waitingReveal').classList.add('hidden');
            } else {
                document.getElementById('hostGameControls').classList.add('hidden');
                document.getElementById('waitingReveal').classList.remove('hidden');
            }
        }

        function openVarModal() {
            if (currentWordData && currentWordData.desc) {
                showModal(currentWordData.desc, 'var');
            }
        }

        function revealGame() {
            const msg = { type: 'REVEAL', wordData: gameState.wordData, impostorName: gameState.impostorName };
            connections.forEach(c => c.send(msg));
            showResult(msg.wordData, msg.impostorName);
        }

        function showResult(wordData, impostorName) {
            showScreen('result');
            document.getElementById('finalWord').innerText = wordData.title;
            document.getElementById('finalDesc').innerText = wordData.desc || "Sin descripci√≥n.";
            document.getElementById('finalImpostor').innerText = impostorName;
            
            if(isHost) {
                document.getElementById('hostRestartControls').classList.remove('hidden');
                document.getElementById('clientRestartWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostRestartControls').classList.add('hidden');
                document.getElementById('clientRestartWaiting').classList.remove('hidden');
            }
        }

        function returnToLobby() {
            broadcastLobby();
            connections.forEach(c => c.send({ type: 'RESET' }));
            showScreen('lobby');
        }

        function updateLobbyUI() {
            const pitch = document.getElementById('pitchContainer');
            // Reset pitch but keep lines
            pitch.innerHTML = `
                <div class="pitch-area-top"></div>
                <div class="pitch-circle"></div>
                <div class="pitch-line-center"></div>
                <div class="pitch-area-bottom"></div>
            `;
            
            document.getElementById('playerCount').innerText = players.length;

            // RENDERIZAR JUGADORES
            players.forEach((p) => {
                // Usar la posici√≥n guardada o fallback
                const posIndex = (p.posIndex !== undefined) ? p.posIndex : (FORMATION.length -1);
                const posData = FORMATION[posIndex] || FORMATION[FORMATION.length - 1];
                
                const playerDiv = document.createElement('div');
                playerDiv.className = 'pitch-player';
                playerDiv.style.left = posData.x + '%';
                playerDiv.style.top = posData.y + '%';
                
                let capiLabel = p.isHost ? '<span class="host-mark">(CAPI)</span>' : '';
                
                // Kick action
                if(isHost && !p.isHost) {
                    playerDiv.onclick = () => kickPlayer(p.id);
                    playerDiv.style.cursor = "pointer";
                }

                playerDiv.innerHTML = `
                    <div class="kit-shirt">üëï</div>
                    <div class="player-tag">${p.name}</div>
                    <div class="position-tag">${posData.name} ${capiLabel}</div>
                `;
                pitch.appendChild(playerDiv);
            });
        }
        
        function kickPlayer(id) {
            showModal("¬øExpulsar del equipo?", "confirm", () => {
                const conn = connections.find(c => c.peer === id);
                if (conn) conn.close();
                players = players.filter(p => p.id !== id);
                connections = connections.filter(c => c.peer !== id);
                broadcastLobby();
            });
        }

        function copyRoomCode() {
            const el = document.getElementById('roomIdDisplay');
            const text = el.innerText;
            if(text === "Cargando...") return;
            navigator.clipboard.writeText(text);
            
            const originalText = text;
            el.innerText = "¬°COPIADO! ‚úÖ";
            el.style.backgroundColor = "#d1f2eb";
            el.style.borderColor = "#2ed573";
            
            setTimeout(() => {
                el.innerText = originalText;
                el.style.backgroundColor = "#e2e8f0";
                el.style.borderColor = "#94a3b8";
            }, 1200);
        }
    </script>
</body>
</html>
