<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Malaguista üíôü§ç</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* COLORES M√ÅLAGA CF */
            --mcf-sky: #6CABDD;
            --mcf-dark: #004488;
            --mcf-gold: #D4AF37;
            --white: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.96);
            --danger: #e74c3c;
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            /* FONDO ESTADIO + DEGRADADO DIVERTIDO */
            background: 
                linear-gradient(135deg, rgba(0, 68, 136, 0.8), rgba(108, 171, 221, 0.7)),
                url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg/1200px-Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg') no-repeat center center fixed;
            background-size: cover;
        }

        /* EMOJIS FLOTANTES (DETR√ÅS DEL CONTENIDO) */
        .emoji-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .floating-emoji {
            position: absolute;
            bottom: -50px; /* Empiezan abajo del todo */
            animation: riseUp linear infinite;
            opacity: 0.6; /* M√°s visibles */
            z-index: 0;
        }
        @keyframes riseUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.7; }
            90% { opacity: 0.7; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        /* CABECERA */
        header {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
            text-align: center; z-index: 10;
        }
        .shield {
            width: 100px; height: auto; margin-bottom: 15px;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.6));
            animation: floatShield 6s ease-in-out infinite;
        }
        @keyframes floatShield { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        h1 {
            font-family: 'Teko', sans-serif; font-size: 4.5rem; text-transform: uppercase;
            margin: 0; line-height: 0.8;
            color: white;
            text-shadow: 4px 4px 0px var(--mcf-dark);
        }
        .subtitle { 
            color: var(--white); background: var(--mcf-dark); padding: 5px 15px; 
            border-radius: 20px; font-size: 0.9rem; letter-spacing: 2px; font-weight: 800; 
            text-transform: uppercase; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* BARRA DE ESTADO (SOLO VISIBLE CON TEXTO) */
        #statusMsg {
            color: white; margin-bottom: 15px; font-weight: 700; 
            background: rgba(0,0,0,0.6); border-radius: 8px; z-index: 10;
            padding: 0; transition: padding 0.3s;
        }
        #statusMsg:not(:empty) { padding: 10px 20px; }

        /* CONTENEDOR PRINCIPAL */
        .main-card {
            background: var(--card-bg);
            width: 100%; max-width: 900px;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                0 0 0 6px rgba(255,255,255,0.2); /* Borde cristal */
            text-align: center;
            position: relative;
            z-index: 10; /* POR ENCIMA DE LOS EMOJIS */
            backdrop-filter: blur(10px);
        }

        /* INPUTS */
        input {
            width: 100%; padding: 20px; margin: 15px 0;
            background: #f4f7f9; border: 2px solid #dae1e7;
            border-radius: 15px; color: var(--mcf-dark);
            font-family: 'Montserrat'; font-weight: 700; font-size: 1.2rem;
            text-align: center; outline: none;
        }
        input:focus { border-color: var(--mcf-sky); background: white; box-shadow: 0 0 0 5px rgba(108, 171, 221, 0.3); transform: scale(1.02); }

        /* BOTONES */
        button {
            width: 100%; padding: 22px; margin-top: 20px;
            background: linear-gradient(135deg, var(--mcf-sky) 0%, var(--mcf-dark) 100%);
            color: white; border: none; border-radius: 15px;
            font-family: 'Teko', sans-serif; font-size: 2rem; letter-spacing: 1px;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 10px 25px rgba(0, 68, 136, 0.4);
            position: relative; overflow: hidden;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0, 68, 136, 0.5); filter: brightness(1.1); }
        button:active { transform: translateY(1px); }

        button.secondary {
            background: white; border: 3px solid var(--mcf-dark); color: var(--mcf-dark);
            box-shadow: none;
        }
        button.secondary:hover { background: var(--mcf-dark); color: white; }
        
        button.danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .hidden { display: none !important; }

        /* LISTAS */
        .player-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .player-card-mini {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 800; color: var(--mcf-dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 5px solid var(--mcf-sky);
        }
        .host-badge { background: var(--mcf-gold); color: white; padding: 3px 8px; border-radius: 50px; font-size: 0.7rem; }

        /* ROL */
        .role-section {
            background: #f1f5f9; border-radius: 20px; padding: 30px;
            border: 2px dashed #cbd5e1; margin-bottom: 30px;
        }
        .role-title { font-size: 0.9rem; color: #64748b; text-transform: uppercase; font-weight: 800; letter-spacing: 2px; margin-bottom: 10px;}

        .secret-word {
            font-family: 'Teko', sans-serif; font-size: 4.5rem; color: var(--mcf-dark);
            margin: 5px 0; line-height: 1; text-transform: uppercase;
        }
        .impostor-text {
            font-family: 'Teko', sans-serif; font-size: 4.5rem; color: var(--danger);
            margin: 5px 0; line-height: 1; text-transform: uppercase; animation: pulse 1s infinite;
        }

        /* DESCRIPCI√ìN CON BOT√ìN LEER M√ÅS MEJORADO */
        .desc-container {
            background: white; padding: 25px; border-radius: 15px; border-left: 6px solid var(--mcf-sky);
            text-align: left; margin-top: 15px; position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .desc-text {
            font-size: 1.1rem; color: #444; line-height: 1.6;
            max-height: 80px; overflow: hidden; transition: max-height 0.6s cubic-bezier(0, 1, 0, 1);
        }
        
        /* Efecto de desvanecimiento cuando est√° cerrado */
        .desc-text:not(.expanded)::after {
            content: ""; position: absolute; bottom: 45px; left: 0; width: 100%; height: 50px;
            background: linear-gradient(transparent, white); pointer-events: none;
        }

        .desc-text.expanded { max-height: 600px; } /* Se expande */
        .desc-text.expanded::after { display: none; }

        .read-more-btn {
            background: #eef2f6; color: var(--mcf-dark); border: none; font-size: 0.9rem;
            padding: 10px; margin-top: 15px; cursor: pointer; font-weight: 800; 
            width: 100%; border-radius: 8px; transition: 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .read-more-btn:hover { background: var(--mcf-dark); color: white; transform: none; box-shadow: none; }

        /* ALINEACI√ìN (TURNOS) */
        .lineup-list {
            list-style: none; padding: 0; text-align: left;
            background: var(--mcf-dark); color: white; border-radius: 15px; overflow: hidden;
        }
        .lineup-item {
            padding: 18px 25px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center;
        }
        .lineup-item:last-child { border-bottom: none; }
        .dorsal {
            font-family: 'Teko'; font-size: 2rem; width: 50px; text-align: center;
            background: rgba(255,255,255,0.15); border-radius: 8px; margin-right: 20px;
            color: var(--mcf-sky);
        }
        .player-name-turn { font-weight: 700; font-size: 1.2rem; }
        .turn-indicator { 
            margin-left: auto; font-size: 0.8rem; background: var(--mcf-gold); 
            color: var(--mcf-dark); padding: 4px 10px; border-radius: 20px; font-weight: 800; 
        }

        /* COPY CODE */
        #roomIdDisplay {
            font-family: monospace; font-size: 1.6rem; font-weight: 800; color: var(--mcf-dark);
            background: #f8fafc; padding: 20px; border-radius: 12px; border: 3px dashed #cbd5e1;
            cursor: pointer; display: inline-block; margin-top: 10px; width: 100%;
        }
        #roomIdDisplay:hover { border-color: var(--mcf-sky); background: white; }

        .kick-btn { width: auto; padding: 5px 12px; margin: 0; font-size: 0.8rem; background: #e74c3c; box-shadow: none; font-family: 'Montserrat'; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="emojiContainer" class="emoji-container"></div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/it/8/80/Malaga_CF.png" alt="Escudo M√°laga CF" class="shield">
        <h1>IMPOSTOR<br><span style="font-size: 3.5rem; color: var(--white);">MALAGUISTA</span></h1>
        <div class="subtitle">‚öΩ LA BOMBONERA EDITION ‚öΩ</div>
    </header>

    <div id="statusMsg"></div>

    <div id="screen-menu" class="main-card">
        <h2 style="font-family:'Teko'; font-size: 2.5rem; margin-top:0;">FICHAJE NUEVO ‚úçÔ∏è</h2>
        <input type="text" id="myUsername" placeholder="Nombre del Jugador" maxlength="12">
        <button onclick="createGame()">CREAR VESTUARIO</button>
        <div style="margin: 20px 0; font-weight: 800; color: #94a3b8;">‚Äî O √öNETE AL EQUIPO ‚Äî</div>
        <input type="text" id="joinInput" placeholder="C√≥digo del Partido">
        <button class="secondary" onclick="joinGame()">UNIRSE AL EQUIPO</button>
    </div>

    <div id="screen-lobby" class="main-card hidden">
        <h2 style="font-family:'Teko'; font-size: 3rem; margin:0;">VESTUARIO üèüÔ∏è</h2>
        <p style="color: #64748b;">Comparte el c√≥digo con la plantilla:</p>
        <div id="roomIdDisplay" onclick="copyRoomCode()">Cargando...</div>

        <h3 style="text-align: left; margin-top: 30px; color: var(--mcf-dark); font-family:'Teko'; font-size: 2rem;">CONVOCADOS (<span id="playerCount">0</span>)</h3>
        <ul id="lobbyList" class="player-list"></ul>

        <div id="hostControls" class="hidden" style="margin-top: 30px;">
            <button onclick="startGame()" id="btnStart">‚öΩ ¬°PITIDO INICIAL! ‚öΩ</button>
        </div>
        <div id="clientWaiting" class="hidden">
            <p style="color: var(--mcf-sky); font-weight: 800; margin-top: 25px; font-size: 1.2rem; animation: pulse 2s infinite;">CALENTANDO EN LA BANDA... üèÉ‚Äç‚ôÇÔ∏è</p>
        </div>
    </div>

    <div id="screen-game" class="main-card hidden">
        <div class="role-section">
            <div class="role-title">TU POSICI√ìN EN EL CAMPO</div>
            <div id="roleContent"></div>
        </div>

        <div style="text-align: left;">
            <h3 style="color: var(--mcf-dark); font-family: 'Teko'; font-size: 2rem; margin-bottom: 15px;">üìã ALINEACI√ìN DEL PARTIDO</h3>
            <ul id="turnOrderList" class="lineup-list"></ul>
        </div>
        
        <div id="hostGameControls" class="hidden" style="margin-top: 20px;">
            <button class="danger" onclick="revealGame()">üõë PITIDO FINAL (REVELAR)</button>
        </div>
        <p id="waitingReveal" class="hidden" style="margin-top:20px; color: #94a3b8; font-weight:600;">PARTIDO EN JUEGO... ‚öΩ</p>
    </div>

    <div id="screen-result" class="main-card hidden">
        <h2 style="font-family: 'Teko'; font-size: 3.5rem; color: var(--mcf-dark); margin:0;">MARCADOR FINAL</h2>
        
        <div style="background: #f1f5f9; padding: 25px; border-radius: 15px; margin: 25px 0; border: 1px solid #e2e8f0;">
            <p style="color: #64748b; margin: 0; font-size: 0.9rem; font-weight:800; letter-spacing:1px;">LA PALABRA ERA:</p>
            <div id="finalWord" style="font-size: 3rem; color: var(--mcf-dark); font-family: 'Teko'; font-weight: bold;"></div>
            <p id="finalDesc" style="font-size: 1rem; color: #475569; font-style: italic; margin-top:10px;"></p>
        </div>

        <p style="color: #64748b; font-weight:800; margin-bottom:0;">EL IMPOSTOR ERA:</p>
        <h3 id="finalImpostor" style="font-family: 'Teko'; font-size: 4rem; color: var(--danger); margin: 0; line-height:1;"></h3>
        
        <div id="hostRestartControls" class="hidden">
            <button onclick="returnToLobby()">üîÑ VOLVER AL VESTUARIO</button>
        </div>
        <p id="clientRestartWaiting" class="hidden" style="color: #94a3b8; margin-top:20px;">ESPERANDO AL M√çSTER...</p>
    </div>

    <script>
        // --- GENERADOR DE EMOJIS TIPO BURBUJA ---
        const emojiContainer = document.getElementById('emojiContainer');
        const emojis = ["‚öΩ", "üêü", "üíô", "ü§ç", "üèüÔ∏è", "üåä", "ü•ò", "üåû"];
        
        // Creamos m√°s emojis para que sea divertido
        for(let i=0; i<35; i++) {
            let el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'floating-emoji';
            // Posici√≥n horizontal aleatoria
            el.style.left = Math.random() * 100 + 'vw';
            // Duraci√≥n aleatoria (algunos r√°pidos, otros lentos)
            el.style.animationDuration = (Math.random() * 15 + 10) + 's';
            // Retraso aleatorio para que no salgan todos a la vez
            el.style.animationDelay = Math.random() * 10 + 's';
            // Tama√±o variado
            el.style.fontSize = (Math.random() * 2 + 1.5) + 'rem';
            emojiContainer.appendChild(el);
        }

        // --- BASE DE DATOS (Tu lista completa) ---
        const PALABRAS_JUEGO = [
            "Perro", "Gato", "Hamster", "Conejo", "Loro", "P√°jaro", "√Åguila", "B√∫ho", "Ping√ºino", "Pato", "Gallina", "Gallo", "Vaca", "Cerdo", "Oveja", "Caballo", "Burro", "Cabra", "Le√≥n", "Tigre", "Leopardo", "Pantera", "Elefante", "Jirafa", "Rinoceronte", "Hipop√≥tamo", "Cebra", "Oso", "Oso Panda", "Oso Polar", "Koala", "Canguro", "Mono", "Gorila", "Chimpanc√©", "Lobo", "Zorro", "Ciervo", "Ardilla", "Rat√≥n", "Rata", "Murci√©lago", "Ballena", "Delf√≠n", "Tibur√≥n", "Pulpo", "Cangrejo", "Tortuga", "Cocodrilo", "Serpiente", "Cobra", "Rana", "Sapo", "Camale√≥n", "Iguana", "Dinosaurio", "T-Rex", "Drag√≥n", "Unicornio", "Mariposa", "Abeja", "Hormiga", "Ara√±a", "Mosquito", "Mosca", "Cucaracha", "Escorpi√≥n", "Caracol", "Medusa", "Estrella de Mar", "Pez Payaso", "Salm√≥n", "Flamenco", "Cisne", "Pavo Real", "Capibara", "Nutria", "Erizo",
            "M√≥vil", "iPhone", "Cargador", "Auriculares", "Ordenador", "Port√°til", "Tablet", "Teclado", "Rat√≥n", "Pantalla", "Televisi√≥n", "Mando a distancia", "C√°mara", "Reloj", "Despertador", "L√°mpara", "Bombilla", "Linterna", "Vela", "Mechero", "Caja", "Maleta", "Mochila", "Bolso", "Cartera", "Llaves", "Llavero", "Gafas", "Gafas de Sol", "Paraguas", "Mesa", "Silla", "Sof√°", "Sill√≥n", "Cama", "Almohada", "Manta", "S√°bana", "Espejo", "Peine", "Cepillo de dientes", "Pasta de dientes", "Jab√≥n", "Champ√∫", "Toalla", "Papel Higi√©nico", "Escoba", "Fregona", "Cubo", "Basura", "Lavadora", "Nevera", "Microondas", "Horno", "Sart√©n", "Olla", "Plato", "Vaso", "Taza", "Cuchillo", "Tenedor", "Cuchara", "Botella", "Servilleta", "Libro", "Cuaderno", "Bol√≠grafo", "L√°piz", "Goma de borrar", "Tijeras", "Pegamento", "Regla", "Papel", "Carta", "Sobre", "Sello", "Peri√≥dico", "Revista", "Mapa", "Bandera", "Moneda", "Billete", "Tarjeta de Cr√©dito", "Anillo", "Collar", "Pendientes", "Pulsera", "Reloj de pulsera",
            "Star Wars", "Darth Vader", "Yoda", "Luke Skywalker", "Princesa Leia", "Sable de Luz", "Harry Potter", "Hermione", "Ron Weasley", "Voldemort", "Varita M√°gica", "Hogwarts", "El Se√±or de los Anillos", "Frodo", "Gandalf", "Gollum", "Anillo", "Marvel", "Avengers", "Iron Man", "Spiderman", "Capit√°n Am√©rica", "Thor", "Hulk", "Thanos", "Batman", "Joker", "Superman", "Wonder Woman", "Disney", "Mickey Mouse", "Minnie", "Pato Donald", "Rey Le√≥n", "Simba", "Frozen", "Elsa", "Olaf", "Toy Story", "Woody", "Buzz Lightyear", "Shrek", "Burro", "Fiona", "Minions", "Gru", "Piratas del Caribe", "Jack Sparrow", "Titanic", "Barco", "Avatar", "Azul", "Jurassic Park", "T-Rex", "Stranger Things", "Once (Eleven)", "Mi√©rcoles (Wednesday)", "La Casa de Papel", "M√°scara de Dal√≠", "El Juego del Calamar", "Friends", "Juego de Tronos", "Drag√≥n", "Jon Snow", "Breaking Bad", "Los Simpson", "Homer Simpson", "Barbie", "Ken", "Oppenheimer", "Bomba", "Cine", "Pel√≠cula", "Palomitas", "Netflix", "Hollywood", "Oscar", "Actor", "Actriz", "Director",
            "Brad Pitt", "Leonardo DiCaprio", "Tom Cruise", "Johnny Depp", "Will Smith", "Angelina Jolie", "Jennifer Lawrence", "Emma Watson", "Zendaya", "Tom Holland", "Chris Hemsworth", "Dwayne Johnson (The Rock)", "Marilyn Monroe", "Elvis Presley", "Michael Jackson", "Freddie Mercury", "Madonna", "Shakira", "Beyonc√©", "Rihanna", "Taylor Swift", "Lady Gaga", "Ariana Grande", "Justin Bieber", "Selena Gomez", "Miley Cyrus", "Harry Styles", "Bad Bunny", "Rosal√≠a", "Karol G", "Daddy Yankee", "Eminem", "Bizarrap", "BTS",
            "Super Mario", "Luigi", "Princesa Peach", "Mario Kart", "Nintendo", "PlayStation", "Xbox", "Fortnite", "Minecraft", "Bloque", "Pico", "Espada", "Zelda", "Link", "Pok√©mon", "Pikachu", "Pok√©ball", "Charizard", "Among Us", "Impostor", "Tripulante", "GTA", "Coches", "FIFA", "F√∫tbol", "Call of Duty", "Disparos", "League of Legends", "Roblox", "Pac-Man", "Tetris", "Sonic", "Erizo", "Mando", "Consola", "Ordenador Gamer", "Streamer", "Youtuber", "Twitch", "Lag", "Game Over", "Nivel", "Vida", "Jefe Final",
            "F√∫tbol", "Bal√≥n", "Porter√≠a", "Gol", "√Årbitro", "Tarjeta Roja", "Penalti", "Lionel Messi", "Cristiano Ronaldo", "Neymar", "Mbapp√©", "Haaland", "Sergio Ramos", "Piqu√©", "Iniesta", "Maradona", "Pel√©", "Real Madrid", "Bar√ßa", "M√°laga CF", "Baloncesto", "Canasta", "Michael Jordan", "LeBron James", "Kobe Bryant", "Pau Gasol", "NBA", "Tenis", "Raqueta", "Rafa Nadal", "Roger Federer", "Djokovic", "Alcaraz", "F√≥rmula 1", "Coche de carreras", "Fernando Alonso", "Lewis Hamilton", "Ferrari", "MotoGP", "Moto", "Marc M√°rquez", "Valentino Rossi", "Nataci√≥n", "Piscina", "Atletismo", "Correr", "Juegos Ol√≠mpicos", "Medalla de Oro", "Gimnasio", "Boxeo", "Ring", "Guantes",
            "Ciudad", "Pueblo", "Playa", "Mar", "Monta√±a", "Bosque", "Selva", "Desierto", "Isla", "Volc√°n", "Cueva", "R√≠o", "Lago", "Cascada", "Parque", "Jard√≠n", "Granja", "Zool√≥gico", "Escuela", "Hospital", "Aeropuerto", "Estaci√≥n de tren", "Restaurante", "Hotel", "Supermercado", "Centro Comercial", "Cine", "Museo", "Iglesia", "Cementerio", "Castillo", "Palacio", "Casa", "Edificio", "Rascacielos", "Puente", "Carretera", "Espa√±a", "Madrid", "Barcelona", "M√°laga", "Par√≠s", "Torre Eiffel", "Londres", "Big Ben", "Nueva York", "Estatua de la Libertad", "Roma", "Coliseo", "Egipto", "Pir√°mides", "China", "Muralla China", "Jap√≥n", "Tokio", "Polo Norte", "Espacio", "Luna", "Sol", "Estrellas", "Planeta", "Tierra",
            "Pizza", "Hamburguesa", "Patatas Fritas", "Hot Dog", "Sandwich", "Bocadillo", "Ensalada", "Sopa", "Arroz", "Pasta", "Espaguetis", "Macarrones", "Huevo", "Huevo Frito", "Tortilla", "Pollo", "Carne", "Pescado", "Sushi", "Tacos", "Burrito", "Pan", "Queso", "Jam√≥n", "Fruta", "Manzana", "Pl√°tano", "Naranja", "Fresa", "Uvas", "Sand√≠a", "Mel√≥n", "Pi√±a", "Lim√≥n", "Tomate", "Lechuga", "Patata", "Zanahoria", "Cebolla", "Ajo", "Sal", "Az√∫car", "Pimienta", "Aceite", "Chocolate", "Helado", "Tarta", "Pastel", "Galleta", "Donut", "Cruas√°n", "Yogur", "Leche", "Agua", "Zumo", "Refresco", "Coca-Cola", "Caf√©", "T√©", "Cerveza", "Vino",
            "Camiseta", "Pantalones", "Vaqueros", "Vestido", "Falda", "Jersey", "Sudadera", "Abrigo", "Chaqueta", "Camisa", "Traje", "Corbata", "Pijama", "Ropa Interior", "Calcetines", "Zapatos", "Zapatillas", "Deportivas", "Botas", "Tacones", "Sandalias", "Chanclas", "Gorro", "Sombrero", "Gorra", "Bufanda", "Guantes", "Ba√±ador", "Bikini", "Cintur√≥n", "Disfraz", "Maquillaje", "Pintalabios", "Perfume", "Colonia",
            "Guitarra", "Piano", "Viol√≠n", "Bater√≠a", "Trompeta", "Saxof√≥n", "Flauta", "Tambor", "Micr√≥fono", "M√∫sica", "Canci√≥n", "Cantante", "Bailar√≠n", "Baile", "Pintura", "Cuadro", "Pincel", "Color", "Escultura", "Teatro", "Circo", "Mago", "Payaso",
            "Coche", "Moto", "Bicicleta", "Patinete", "Autob√∫s", "Taxi", "Tren", "Metro", "Avi√≥n", "Helic√≥ptero", "Barco", "Crucero", "Submarino", "Cami√≥n", "Furgoneta", "Tractor", "Ambulancia", "Coche de Polic√≠a", "Cami√≥n de Bomberos", "Cohete", "Ovni",
            "M√©dico", "Enfermera", "Polic√≠a", "Bombero", "Profesor", "Estudiante", "Cocinero", "Camarero", "Peluquero", "Astronauta", "Piloto", "Soldado", "Rey", "Reina", "Princesa", "Pr√≠ncipe", "Pirata", "Ninja", "Vampiro", "Zombi", "Fantasma", "Bruja", "Hada", "Sirena", "Robot", "Alien", "Amor", "Odio", "Miedo", "Alegr√≠a", "Tristeza", "Suerte", "Tiempo", "Vida", "Muerte", "Boda", "Cumplea√±os", "Navidad", "Halloween", "Verano", "Invierno", "Fr√≠o", "Calor", "Lluvia", "Nieve", "Viento", "Tormenta", "Arcoiris", "Fuego", "Humo", "Luz", "Oscuridad", "Sombra", "Sue√±o", "Pesadilla", "Dinero", "Trabajo", "Fiesta", "Vacaciones", "Regalo", "Sorpresa"
        ];

        // --- L√ìGICA DE JUEGO & CONEXI√ìN ---
        let peer = null;
        let connections = [];
        let isHost = false;
        let myName = "";
        let players = []; 
        let gameState = {}; 

        const screens = ['menu', 'lobby', 'game', 'result'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
            document.getElementById(`screen-${name}`).classList.remove('hidden');
        }
        function updateStatus(msg) { 
            const el = document.getElementById('statusMsg');
            el.innerText = msg; 
            // La clase CSS se encarga del padding si hay texto o no
        }

        async function getWordAndDescription() {
            const rawWord = PALABRAS_JUEGO[Math.floor(Math.random() * PALABRAS_JUEGO.length)];
            const url = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&exchars=450&titles=${encodeURIComponent(rawWord)}&format=json&origin=*`;
            
            let description = "Informaci√≥n clasificada. Investiga por tu cuenta."; 

            try {
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId !== "-1") {
                    const extract = pages[pageId].extract;
                    if (extract && extract.length > 5) {
                        description = extract;
                    }
                }
            } catch (e) {
                console.log("Wiki fetch failed, using fallback.");
            }

            return { title: rawWord, desc: description };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- PEERJS ---
        function createGame() {
            myName = document.getElementById('myUsername').value.trim() || "Jugador N¬∫12";
            isHost = true;
            updateStatus("Abriendo puertas de La Rosaleda...");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                document.getElementById('roomIdDisplay').innerText = id;
                updateStatus("");
                players = [{ id: id, name: myName, isHost: true }];
                updateLobbyUI();
                showScreen('lobby');
                document.getElementById('hostControls').classList.remove('hidden');
            });

            peer.on('connection', (c) => {
                c.on('open', () => { c.on('data', (d) => handleDataHost(d, c)); });
                c.on('close', () => {
                    players = players.filter(p => p.id !== c.peer);
                    connections = connections.filter(con => con.peer !== c.peer);
                    broadcastLobby();
                });
            });
        }

        function joinGame() {
            myName = document.getElementById('myUsername').value.trim() || "Aficionado";
            const roomId = document.getElementById('joinInput').value.trim();
            if (!roomId) return alert("¬°Falta el c√≥digo del partido!");
            
            isHost = false;
            updateStatus("Entrando al campo...");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                const conn = peer.connect(roomId);
                conn.on('open', () => {
                    updateStatus("En el vestuario");
                    conn.send({ type: 'JOIN', name: myName, id: id });
                    connections = [conn]; 
                });
                conn.on('data', (d) => handleDataClient(d));
                conn.on('close', () => { alert("El entrenador cerr√≥ la sesi√≥n."); location.reload(); });
            });
        }

        function handleDataHost(data, connSource) {
            if (data.type === 'JOIN') {
                if (!players.find(p => p.id === data.id)) {
                    connections.push(connSource);
                    players.push({ id: data.id, name: data.name });
                    broadcastLobby();
                }
            }
        }

        function handleDataClient(data) {
            if (data.type === 'LOBBY') {
                players = data.players;
                showScreen('lobby');
                updateLobbyUI();
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('clientWaiting').classList.remove('hidden');
            }
            if (data.type === 'START') setupGame(data.wordData, data.impostor, data.order);
            if (data.type === 'REVEAL') showResult(data.wordData, data.impostorName);
            if (data.type === 'RESET') showScreen('lobby');
        }

        function broadcastLobby() {
            const safePlayers = players.map(p => ({ id: p.id, name: p.name, isHost: p.isHost }));
            const msg = { type: 'LOBBY', players: safePlayers };
            if (!isHost) return;
            updateLobbyUI();
            connections.forEach(c => c.send(msg));
        }

        async function startGame() {
            if (players.length < 3 && !confirm("¬øMenos de 3 jugadores? Va a ser un rondo aburrido.")) return;
            
            const btn = document.getElementById('btnStart');
            btn.innerText = "‚è≥ SORTEANDO CAMPO...";
            btn.disabled = true;

            const wordData = await getWordAndDescription();
            
            const impostor = players[Math.floor(Math.random() * players.length)];
            let turnOrder = [...players];
            turnOrder = shuffleArray(turnOrder).map(p => p.name);

            gameState = { wordData: wordData, impostorName: impostor.name };
            
            const msg = { 
                type: 'START', 
                wordData: wordData, 
                impostor: impostor.id,
                order: turnOrder
            };
            
            connections.forEach(c => c.send(msg));
            setupGame(wordData, impostor.id, turnOrder);

            btn.innerText = "‚öΩ ¬°PITIDO INICIAL! ‚öΩ";
            btn.disabled = false;
        }

        // --- FUNCI√ìN DEL JUEGO ---
        function setupGame(wordData, impostorId, orderList) {
            showScreen('game');
            const amIImpostor = (peer.id === impostorId);
            
            const container = document.getElementById('roleContent');
            container.innerHTML = ''; 

            if (amIImpostor) {
                container.innerHTML = `
                    <div class="impostor-text">IMPOSTOR</div>
                    <p style="color: #64748b; font-size: 1.1rem; font-weight:600;">Nadie sabe que eres t√∫. Finge y miente.</p>
                `;
            } else {
                container.innerHTML = `
                    <div class="secret-word">${wordData.title}</div>
                    <div class="desc-container">
                        <div class="desc-text" id="descText">${wordData.desc}</div>
                        <button class="read-more-btn" onclick="toggleDesc()">‚¨á VER INFO COMPLETA</button>
                    </div>
                `;
            }

            // ALINEACI√ìN (Turnos)
            const ul = document.getElementById('turnOrderList');
            ul.innerHTML = '';
            orderList.forEach((name, index) => {
                const li = document.createElement('li');
                li.className = 'lineup-item';
                
                let extraHtml = '';
                if(index === 0) extraHtml = '<span class="turn-indicator">EMPIEZA ‚öΩ</span>';

                li.innerHTML = `
                    <div class="dorsal">${index + 1}</div>
                    <div class="player-name-turn">${name}</div>
                    ${extraHtml}
                `;
                ul.appendChild(li);
            });

            if (isHost) {
                document.getElementById('hostGameControls').classList.remove('hidden');
                document.getElementById('waitingReveal').classList.add('hidden');
            } else {
                document.getElementById('hostGameControls').classList.add('hidden');
                document.getElementById('waitingReveal').classList.remove('hidden');
            }
        }

        function toggleDesc() {
            const el = document.getElementById('descText');
            el.classList.toggle('expanded');
            const btn = document.querySelector('.read-more-btn');
            if (el.classList.contains('expanded')) {
                btn.innerText = "‚¨Ü OCULTAR";
            } else {
                btn.innerText = "‚¨á VER INFO COMPLETA";
            }
        }

        function revealGame() {
            const msg = { type: 'REVEAL', wordData: gameState.wordData, impostorName: gameState.impostorName };
            connections.forEach(c => c.send(msg));
            showResult(msg.wordData, msg.impostorName);
        }

        function showResult(wordData, impostorName) {
            showScreen('result');
            document.getElementById('finalWord').innerText = wordData.title;
            document.getElementById('finalDesc').innerText = wordData.desc;
            document.getElementById('finalImpostor').innerText = impostorName;
            
            if(isHost) {
                document.getElementById('hostRestartControls').classList.remove('hidden');
                document.getElementById('clientRestartWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostRestartControls').classList.add('hidden');
                document.getElementById('clientRestartWaiting').classList.remove('hidden');
            }
        }

        function returnToLobby() {
            broadcastLobby();
            connections.forEach(c => c.send({ type: 'RESET' }));
            showScreen('lobby');
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobbyList');
            list.innerHTML = '';
            document.getElementById('playerCount').innerText = players.length;
            players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-card-mini';
                
                let btnKick = '';
                if(isHost && p.id !== peer.id) {
                    btnKick = `<button class="kick-btn" onclick="kickPlayer('${p.id}')">EXPULSAR</button>`;
                }
                
                li.innerHTML = `<span>${p.name} ${p.isHost ? '<span class="host-badge">CAPI</span>' : ''}</span> ${btnKick}`;
                list.appendChild(li);
            });
        }
        
        function kickPlayer(id) {
            if(!confirm("¬øSacar a este jugador del equipo?")) return;
            const conn = connections.find(c => c.peer === id);
            if (conn) conn.close();
            players = players.filter(p => p.id !== id);
            connections = connections.filter(c => c.peer !== id);
            broadcastLobby();
        }

        function copyRoomCode() {
            const el = document.getElementById('roomIdDisplay');
            const text = el.innerText;
            if(text === "Cargando...") return;
            navigator.clipboard.writeText(text);
            el.style.backgroundColor = "#d1f2eb";
            el.innerText = "¬°C√ìDIGO COPIADO!";
            setTimeout(() => {
                el.style.backgroundColor = "#f8fafc";
                el.innerText = text;
            }, 1000);
        }
    </script>
</body>
</html>
