<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impostor Malaguista üíôü§ç</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* PALETA M√ÅLAGA CF */
            --mcf-blue-light: #6CABDD; /* Azul Cielo Camiseta */
            --mcf-blue-dark: #004488;  /* Azul Oscuro */
            --mcf-gold: #D4AF37;       /* Dorado Escudo */
            --white: #ffffff;
            --bg-overlay: rgba(0, 20, 40, 0.85);
            --card-glass: rgba(255, 255, 255, 0.95);
            --danger: #e74c3c;
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            color: #333;
            /* FONDO DE LA ROSALEDA */
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg/1200px-Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg') no-repeat center center fixed;
            background-size: cover;
        }

        /* CAPA OSCURA SOBRE EL FONDO */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-overlay); z-index: -1;
        }

        /* CABECERA CON ESCUDO */
        header {
            display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;
            text-align: center;
        }
        .shield {
            width: 90px; height: auto; margin-bottom: 15px;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.4));
            transition: transform 0.3s;
        }
        .shield:hover { transform: scale(1.1); }

        h1 {
            font-family: 'Teko', sans-serif; font-size: 4rem; text-transform: uppercase;
            margin: 0; line-height: 0.9;
            background: linear-gradient(to bottom, var(--white), var(--mcf-blue-light));
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .subtitle { color: var(--mcf-blue-light); font-size: 1rem; letter-spacing: 2px; font-weight: 600; text-transform: uppercase;}

        /* CONTENEDOR PRINCIPAL AMPLIO */
        .main-card {
            background: var(--card-glass);
            width: 100%; max-width: 900px; /* M√ÅS AMPLIO */
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            text-align: center;
            position: relative;
            border-top: 5px solid var(--mcf-blue-light);
            border-bottom: 5px solid var(--mcf-blue-dark);
        }

        /* INPUTS ESTILO CAMISETA */
        input {
            width: 100%; padding: 18px; margin: 15px 0;
            background: #f0f4f8; border: 2px solid #dde6ed;
            border-radius: 12px; color: var(--mcf-blue-dark);
            font-family: 'Montserrat'; font-weight: 600; font-size: 1.1rem;
            text-align: center; outline: none;
        }
        input:focus { border-color: var(--mcf-blue-light); background: white; box-shadow: 0 0 0 4px rgba(108, 171, 221, 0.2); }

        /* BOTONES PRO */
        button {
            width: 100%; padding: 20px; margin-top: 15px;
            background: linear-gradient(135deg, var(--mcf-blue-light) 0%, var(--mcf-blue-dark) 100%);
            color: white; border: none; border-radius: 12px;
            font-family: 'Teko', sans-serif; font-size: 1.8rem; letter-spacing: 1px;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 10px 20px rgba(0, 68, 136, 0.3);
            position: relative; overflow: hidden;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0, 68, 136, 0.4); }
        button:active { transform: translateY(1px); }

        button.secondary {
            background: transparent; border: 3px solid var(--mcf-blue-dark); color: var(--mcf-blue-dark);
            box-shadow: none;
        }
        button.secondary:hover { background: var(--mcf-blue-dark); color: white; }

        button.danger { background: var(--danger); }
        
        .hidden { display: none !important; }

        /* LISTA DE JUGADORES (ALINEACI√ìN) */
        .player-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .player-card-mini {
            background: white; border: 1px solid #eee; padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; color: var(--mcf-blue-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .host-badge { background: var(--mcf-gold); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }

        /* TARJETA DE ROL */
        .role-section {
            background: #f8f9fa; border-radius: 15px; padding: 30px;
            border: 1px solid #eee; margin-bottom: 30px;
        }

        .role-title { font-size: 1rem; color: #888; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; }
        
        /* PALABRA SECRETA */
        .secret-word {
            font-family: 'Teko', sans-serif; font-size: 4rem; color: var(--mcf-blue-dark);
            margin: 10px 0; line-height: 1; text-transform: uppercase;
        }
        .impostor-text {
            font-family: 'Teko', sans-serif; font-size: 4rem; color: var(--danger);
            margin: 10px 0; line-height: 1; text-transform: uppercase; animation: pulse 1.5s infinite;
        }

        /* DESCRIPCI√ìN COLAPSIBLE */
        .desc-container {
            background: white; padding: 20px; border-radius: 10px; border-left: 4px solid var(--mcf-blue-light);
            text-align: left; margin-top: 10px;
        }
        .desc-text {
            font-size: 1rem; color: #555; line-height: 1.6;
            max-height: 60px; overflow: hidden; transition: max-height 0.5s ease-out;
            position: relative;
        }
        .desc-text.expanded { max-height: 500px; } /* Altura suficiente para texto largo */
        
        .read-more-btn {
            background: none; color: var(--mcf-blue-light); border: none; font-size: 0.9rem;
            padding: 5px 0; margin-top: 5px; cursor: pointer; font-weight: bold; width: auto; box-shadow: none; text-align: left;
        }
        .read-more-btn:hover { text-decoration: underline; transform: none; background: none; box-shadow: none; }

        /* ALINEACI√ìN (TURNOS) */
        .lineup-list {
            list-style: none; padding: 0; text-align: left;
            background: var(--mcf-blue-dark); color: white; border-radius: 10px; overflow: hidden;
        }
        .lineup-item {
            padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center;
        }
        .lineup-item:last-child { border-bottom: none; }
        .dorsal {
            font-family: 'Teko'; font-size: 1.5rem; width: 40px; text-align: center;
            background: rgba(255,255,255,0.2); border-radius: 5px; margin-right: 15px;
        }
        .player-name-turn { font-weight: 600; font-size: 1.1rem; }
        .turn-indicator { margin-left: auto; font-size: 0.8rem; color: var(--mcf-gold); text-transform: uppercase; font-weight: bold; }

        /* COPY CODE */
        #roomIdDisplay {
            font-family: monospace; font-size: 1.5rem; font-weight: bold; color: var(--mcf-blue-dark);
            background: #eef2f5; padding: 15px; border-radius: 10px; border: 2px dashed #ccc;
            cursor: pointer; display: inline-block; margin-top: 10px;
        }
        #roomIdDisplay:hover { border-color: var(--mcf-blue-light); background: white; }

        .kick-btn { width: auto; padding: 5px 10px; margin: 0; font-size: 0.8rem; background: #e74c3c; box-shadow: none; font-family: 'Montserrat'; }

        /* EMOJIS DECORATIVOS */
        .floating-emoji { position: fixed; z-index: 0; opacity: 0.1; animation: float 10s infinite ease-in-out; pointer-events: none; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }

    </style>
</head>
<body>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/it/8/80/Malaga_CF.png" alt="Escudo M√°laga CF" class="shield">
        <h1>IMPOSTOR<br><span style="font-size: 2.5rem; color: white;">MALAGUISTA</span></h1>
        <div class="subtitle">‚öΩüíô LA BOMBONERA EDITION üíô‚öΩ</div>
    </header>

    <div id="statusMsg" style="color: white; margin-bottom: 10px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px;"></div>

    <div id="screen-menu" class="main-card">
        <h2>FICHAJE NUEVO ‚úçÔ∏è</h2>
        <input type="text" id="myUsername" placeholder="Nombre del Jugador" maxlength="12">
        <button onclick="createGame()">CREAR VESTUARIO</button>
        <div style="margin: 20px 0; font-weight: bold; color: #888;">‚Äî O √öNETE AL EQUIPO ‚Äî</div>
        <input type="text" id="joinInput" placeholder="C√≥digo del Partido">
        <button class="secondary" onclick="joinGame()">UNIRSE AL EQUIPO</button>
    </div>

    <div id="screen-lobby" class="main-card hidden">
        <h2>VESTUARIO üèüÔ∏è</h2>
        <p>Comparte el c√≥digo con la plantilla:</p>
        <div id="roomIdDisplay" onclick="copyRoomCode()">Cargando...</div>

        <h3 style="text-align: left; margin-top: 30px; color: var(--mcf-blue-dark);">CONVOCADOS (<span id="playerCount">0</span>)</h3>
        <ul id="lobbyList" class="player-list"></ul>

        <div id="hostControls" class="hidden" style="margin-top: 30px;">
            <button onclick="startGame()" id="btnStart">‚öΩ ¬°PITIDO INICIAL! ‚öΩ</button>
        </div>
        <div id="clientWaiting" class="hidden">
            <p style="color: var(--mcf-blue-light); font-weight: bold; margin-top: 20px; font-size: 1.2rem;">CALENTANDO EN LA BANDA... üèÉ‚Äç‚ôÇÔ∏è</p>
        </div>
    </div>

    <div id="screen-game" class="main-card hidden">
        <div class="role-section">
            <div class="role-title">TU POSICI√ìN EN EL CAMPO</div>
            <div id="roleContent"></div>
        </div>

        <div style="text-align: left;">
            <h3 style="color: var(--mcf-blue-dark); font-family: 'Teko'; font-size: 2rem; margin-bottom: 10px;">üìã ALINEACI√ìN (TURNOS)</h3>
            <ul id="turnOrderList" class="lineup-list"></ul>
        </div>
        
        <div id="hostGameControls" class="hidden" style="margin-top: 20px;">
            <button class="danger" onclick="revealGame()">üõë PITIDO FINAL (REVELAR)</button>
        </div>
        <p id="waitingReveal" class="hidden" style="margin-top:20px; color: #888;">PARTIDO EN JUEGO... ‚öΩ</p>
    </div>

    <div id="screen-result" class="main-card hidden">
        <h2 style="font-family: 'Teko'; font-size: 3rem; color: var(--mcf-blue-dark);">MARCADOR FINAL</h2>
        
        <div style="background: #f0f4f8; padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #ddd;">
            <p style="color: #666; margin: 0; font-size: 0.9rem;">LA PALABRA ERA:</p>
            <div id="finalWord" style="font-size: 2.5rem; color: var(--mcf-blue-dark); font-family: 'Teko'; font-weight: bold;"></div>
            <p id="finalDesc" style="font-size: 0.9rem; color: #555; font-style: italic;"></p>
        </div>

        <p style="color: #666;">EL IMPOSTOR ERA:</p>
        <h3 id="finalImpostor" style="font-family: 'Teko'; font-size: 3rem; color: var(--danger); margin: 0;"></h3>
        
        <div id="hostRestartControls" class="hidden">
            <button onclick="returnToLobby()">üîÑ VOLVER AL VESTUARIO</button>
        </div>
        <p id="clientRestartWaiting" class="hidden" style="color: #888; margin-top:20px;">ESPERANDO AL M√çSTER...</p>
    </div>

    <script>
        // --- EMOJIS FLOTANTES ---
        const emojis = ["‚öΩ", "üêü", "üíô", "ü§ç", "üèüÔ∏è", "üåä"];
        for(let i=0; i<10; i++) {
            let el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'floating-emoji';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.top = Math.random() * 100 + 'vh';
            el.style.fontSize = (Math.random() * 2 + 1) + 'rem';
            el.style.animationDuration = (Math.random() * 5 + 5) + 's';
            document.body.appendChild(el);
        }

        // --- BASE DE DATOS (Copiada del prompt anterior) ---
        const PALABRAS_JUEGO = [
            "Perro", "Gato", "Hamster", "Conejo", "Loro", "P√°jaro", "√Åguila", "B√∫ho", "Ping√ºino", "Pato", "Gallina", "Gallo", "Vaca", "Cerdo", "Oveja", "Caballo", "Burro", "Cabra", "Le√≥n", "Tigre", "Leopardo", "Pantera", "Elefante", "Jirafa", "Rinoceronte", "Hipop√≥tamo", "Cebra", "Oso", "Oso Panda", "Oso Polar", "Koala", "Canguro", "Mono", "Gorila", "Chimpanc√©", "Lobo", "Zorro", "Ciervo", "Ardilla", "Rat√≥n", "Rata", "Murci√©lago", "Ballena", "Delf√≠n", "Tibur√≥n", "Pulpo", "Cangrejo", "Tortuga", "Cocodrilo", "Serpiente", "Cobra", "Rana", "Sapo", "Camale√≥n", "Iguana", "Dinosaurio", "T-Rex", "Drag√≥n", "Unicornio", "Mariposa", "Abeja", "Hormiga", "Ara√±a", "Mosquito", "Mosca", "Cucaracha", "Escorpi√≥n", "Caracol", "Medusa", "Estrella de Mar", "Pez Payaso", "Salm√≥n", "Flamenco", "Cisne", "Pavo Real", "Capibara", "Nutria", "Erizo",
            "M√≥vil", "iPhone", "Cargador", "Auriculares", "Ordenador", "Port√°til", "Tablet", "Teclado", "Rat√≥n", "Pantalla", "Televisi√≥n", "Mando a distancia", "C√°mara", "Reloj", "Despertador", "L√°mpara", "Bombilla", "Linterna", "Vela", "Mechero", "Caja", "Maleta", "Mochila", "Bolso", "Cartera", "Llaves", "Llavero", "Gafas", "Gafas de Sol", "Paraguas", "Mesa", "Silla", "Sof√°", "Sill√≥n", "Cama", "Almohada", "Manta", "S√°bana", "Espejo", "Peine", "Cepillo de dientes", "Pasta de dientes", "Jab√≥n", "Champ√∫", "Toalla", "Papel Higi√©nico", "Escoba", "Fregona", "Cubo", "Basura", "Lavadora", "Nevera", "Microondas", "Horno", "Sart√©n", "Olla", "Plato", "Vaso", "Taza", "Cuchillo", "Tenedor", "Cuchara", "Botella", "Servilleta", "Libro", "Cuaderno", "Bol√≠grafo", "L√°piz", "Goma de borrar", "Tijeras", "Pegamento", "Regla", "Papel", "Carta", "Sobre", "Sello", "Peri√≥dico", "Revista", "Mapa", "Bandera", "Moneda", "Billete", "Tarjeta de Cr√©dito", "Anillo", "Collar", "Pendientes", "Pulsera", "Reloj de pulsera",
            "Star Wars", "Darth Vader", "Yoda", "Luke Skywalker", "Princesa Leia", "Sable de Luz", "Harry Potter", "Hermione", "Ron Weasley", "Voldemort", "Varita M√°gica", "Hogwarts", "El Se√±or de los Anillos", "Frodo", "Gandalf", "Gollum", "Anillo", "Marvel", "Avengers", "Iron Man", "Spiderman", "Capit√°n Am√©rica", "Thor", "Hulk", "Thanos", "Batman", "Joker", "Superman", "Wonder Woman", "Disney", "Mickey Mouse", "Minnie", "Pato Donald", "Rey Le√≥n", "Simba", "Frozen", "Elsa", "Olaf", "Toy Story", "Woody", "Buzz Lightyear", "Shrek", "Burro", "Fiona", "Minions", "Gru", "Piratas del Caribe", "Jack Sparrow", "Titanic", "Barco", "Avatar", "Azul", "Jurassic Park", "T-Rex", "Stranger Things", "Once (Eleven)", "Mi√©rcoles (Wednesday)", "La Casa de Papel", "M√°scara de Dal√≠", "El Juego del Calamar", "Friends", "Juego de Tronos", "Drag√≥n", "Jon Snow", "Breaking Bad", "Los Simpson", "Homer Simpson", "Barbie", "Ken", "Oppenheimer", "Bomba", "Cine", "Pel√≠cula", "Palomitas", "Netflix", "Hollywood", "Oscar", "Actor", "Actriz", "Director",
            "Brad Pitt", "Leonardo DiCaprio", "Tom Cruise", "Johnny Depp", "Will Smith", "Angelina Jolie", "Jennifer Lawrence", "Emma Watson", "Zendaya", "Tom Holland", "Chris Hemsworth", "Dwayne Johnson (The Rock)", "Marilyn Monroe", "Elvis Presley", "Michael Jackson", "Freddie Mercury", "Madonna", "Shakira", "Beyonc√©", "Rihanna", "Taylor Swift", "Lady Gaga", "Ariana Grande", "Justin Bieber", "Selena Gomez", "Miley Cyrus", "Harry Styles", "Bad Bunny", "Rosal√≠a", "Karol G", "Daddy Yankee", "Eminem", "Bizarrap", "BTS",
            "Super Mario", "Luigi", "Princesa Peach", "Mario Kart", "Nintendo", "PlayStation", "Xbox", "Fortnite", "Minecraft", "Bloque", "Pico", "Espada", "Zelda", "Link", "Pok√©mon", "Pikachu", "Pok√©ball", "Charizard", "Among Us", "Impostor", "Tripulante", "GTA", "Coches", "FIFA", "F√∫tbol", "Call of Duty", "Disparos", "League of Legends", "Roblox", "Pac-Man", "Tetris", "Sonic", "Erizo", "Mando", "Consola", "Ordenador Gamer", "Streamer", "Youtuber", "Twitch", "Lag", "Game Over", "Nivel", "Vida", "Jefe Final",
            "F√∫tbol", "Bal√≥n", "Porter√≠a", "Gol", "√Årbitro", "Tarjeta Roja", "Penalti", "Lionel Messi", "Cristiano Ronaldo", "Neymar", "Mbapp√©", "Haaland", "Sergio Ramos", "Piqu√©", "Iniesta", "Maradona", "Pel√©", "Real Madrid", "Bar√ßa", "M√°laga CF", "Baloncesto", "Canasta", "Michael Jordan", "LeBron James", "Kobe Bryant", "Pau Gasol", "NBA", "Tenis", "Raqueta", "Rafa Nadal", "Roger Federer", "Djokovic", "Alcaraz", "F√≥rmula 1", "Coche de carreras", "Fernando Alonso", "Lewis Hamilton", "Ferrari", "MotoGP", "Moto", "Marc M√°rquez", "Valentino Rossi", "Nataci√≥n", "Piscina", "Atletismo", "Correr", "Juegos Ol√≠mpicos", "Medalla de Oro", "Gimnasio", "Boxeo", "Ring", "Guantes",
            "Ciudad", "Pueblo", "Playa", "Mar", "Monta√±a", "Bosque", "Selva", "Desierto", "Isla", "Volc√°n", "Cueva", "R√≠o", "Lago", "Cascada", "Parque", "Jard√≠n", "Granja", "Zool√≥gico", "Escuela", "Hospital", "Aeropuerto", "Estaci√≥n de tren", "Restaurante", "Hotel", "Supermercado", "Centro Comercial", "Cine", "Museo", "Iglesia", "Cementerio", "Castillo", "Palacio", "Casa", "Edificio", "Rascacielos", "Puente", "Carretera", "Espa√±a", "Madrid", "Barcelona", "M√°laga", "Par√≠s", "Torre Eiffel", "Londres", "Big Ben", "Nueva York", "Estatua de la Libertad", "Roma", "Coliseo", "Egipto", "Pir√°mides", "China", "Muralla China", "Jap√≥n", "Tokio", "Polo Norte", "Espacio", "Luna", "Sol", "Estrellas", "Planeta", "Tierra",
            "Pizza", "Hamburguesa", "Patatas Fritas", "Hot Dog", "Sandwich", "Bocadillo", "Ensalada", "Sopa", "Arroz", "Pasta", "Espaguetis", "Macarrones", "Huevo", "Huevo Frito", "Tortilla", "Pollo", "Carne", "Pescado", "Sushi", "Tacos", "Burrito", "Pan", "Queso", "Jam√≥n", "Fruta", "Manzana", "Pl√°tano", "Naranja", "Fresa", "Uvas", "Sand√≠a", "Mel√≥n", "Pi√±a", "Lim√≥n", "Tomate", "Lechuga", "Patata", "Zanahoria", "Cebolla", "Ajo", "Sal", "Az√∫car", "Pimienta", "Aceite", "Chocolate", "Helado", "Tarta", "Pastel", "Galleta", "Donut", "Cruas√°n", "Yogur", "Leche", "Agua", "Zumo", "Refresco", "Coca-Cola", "Caf√©", "T√©", "Cerveza", "Vino",
            "Camiseta", "Pantalones", "Vaqueros", "Vestido", "Falda", "Jersey", "Sudadera", "Abrigo", "Chaqueta", "Camisa", "Traje", "Corbata", "Pijama", "Ropa Interior", "Calcetines", "Zapatos", "Zapatillas", "Deportivas", "Botas", "Tacones", "Sandalias", "Chanclas", "Gorro", "Sombrero", "Gorra", "Bufanda", "Guantes", "Ba√±ador", "Bikini", "Cintur√≥n", "Disfraz", "Maquillaje", "Pintalabios", "Perfume", "Colonia",
            "Guitarra", "Piano", "Viol√≠n", "Bater√≠a", "Trompeta", "Saxof√≥n", "Flauta", "Tambor", "Micr√≥fono", "M√∫sica", "Canci√≥n", "Cantante", "Bailar√≠n", "Baile", "Pintura", "Cuadro", "Pincel", "Color", "Escultura", "Teatro", "Circo", "Mago", "Payaso",
            "Coche", "Moto", "Bicicleta", "Patinete", "Autob√∫s", "Taxi", "Tren", "Metro", "Avi√≥n", "Helic√≥ptero", "Barco", "Crucero", "Submarino", "Cami√≥n", "Furgoneta", "Tractor", "Ambulancia", "Coche de Polic√≠a", "Cami√≥n de Bomberos", "Cohete", "Ovni",
            "M√©dico", "Enfermera", "Polic√≠a", "Bombero", "Profesor", "Estudiante", "Cocinero", "Camarero", "Peluquero", "Astronauta", "Piloto", "Soldado", "Rey", "Reina", "Princesa", "Pr√≠ncipe", "Pirata", "Ninja", "Vampiro", "Zombi", "Fantasma", "Bruja", "Hada", "Sirena", "Robot", "Alien", "Amor", "Odio", "Miedo", "Alegr√≠a", "Tristeza", "Suerte", "Tiempo", "Vida", "Muerte", "Boda", "Cumplea√±os", "Navidad", "Halloween", "Verano", "Invierno", "Fr√≠o", "Calor", "Lluvia", "Nieve", "Viento", "Tormenta", "Arcoiris", "Fuego", "Humo", "Luz", "Oscuridad", "Sombra", "Sue√±o", "Pesadilla", "Dinero", "Trabajo", "Fiesta", "Vacaciones", "Regalo", "Sorpresa"
        ];

        // --- L√ìGICA DE JUEGO ---
        let peer = null;
        let connections = [];
        let isHost = false;
        let myName = "";
        let players = []; 
        let gameState = {}; 

        const screens = ['menu', 'lobby', 'game', 'result'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
            document.getElementById(`screen-${name}`).classList.remove('hidden');
        }
        function updateStatus(msg) { document.getElementById('statusMsg').innerText = msg; }

        async function getWordAndDescription() {
            const rawWord = PALABRAS_JUEGO[Math.floor(Math.random() * PALABRAS_JUEGO.length)];
            const url = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&exchars=400&titles=${encodeURIComponent(rawWord)}&format=json&origin=*`;
            
            let description = "Concepto popular. ¬°Investiga y disimula!"; 

            try {
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId !== "-1") {
                    const extract = pages[pageId].extract;
                    if (extract && extract.length > 5) {
                        description = extract;
                    }
                }
            } catch (e) {
                console.log("Wiki fetch failed, using fallback.");
            }

            return { title: rawWord, desc: description };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- PEERJS ---
        function createGame() {
            myName = document.getElementById('myUsername').value.trim() || "Jugador N¬∫12";
            isHost = true;
            updateStatus("Abriendo puertas del estadio...");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                document.getElementById('roomIdDisplay').innerText = id;
                updateStatus("");
                players = [{ id: id, name: myName, isHost: true }];
                updateLobbyUI();
                showScreen('lobby');
                document.getElementById('hostControls').classList.remove('hidden');
            });

            peer.on('connection', (c) => {
                c.on('open', () => { c.on('data', (d) => handleDataHost(d, c)); });
                c.on('close', () => {
                    players = players.filter(p => p.id !== c.peer);
                    connections = connections.filter(con => con.peer !== c.peer);
                    broadcastLobby();
                });
            });
        }

        function joinGame() {
            myName = document.getElementById('myUsername').value.trim() || "Aficionado";
            const roomId = document.getElementById('joinInput').value.trim();
            if (!roomId) return alert("¬°Falta el c√≥digo del partido!");
            
            isHost = false;
            updateStatus("Entrando al campo...");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                const conn = peer.connect(roomId);
                conn.on('open', () => {
                    updateStatus("En el vestuario");
                    conn.send({ type: 'JOIN', name: myName, id: id });
                    connections = [conn]; 
                });
                conn.on('data', (d) => handleDataClient(d));
                conn.on('close', () => { alert("El entrenador cerr√≥ la sesi√≥n."); location.reload(); });
            });
        }

        function handleDataHost(data, connSource) {
            if (data.type === 'JOIN') {
                if (!players.find(p => p.id === data.id)) {
                    connections.push(connSource);
                    players.push({ id: data.id, name: data.name });
                    broadcastLobby();
                }
            }
        }

        function handleDataClient(data) {
            if (data.type === 'LOBBY') {
                players = data.players;
                showScreen('lobby');
                updateLobbyUI();
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('clientWaiting').classList.remove('hidden');
            }
            if (data.type === 'START') setupGame(data.wordData, data.impostor, data.order);
            if (data.type === 'REVEAL') showResult(data.wordData, data.impostorName);
            if (data.type === 'RESET') showScreen('lobby');
        }

        function broadcastLobby() {
            const safePlayers = players.map(p => ({ id: p.id, name: p.name, isHost: p.isHost }));
            const msg = { type: 'LOBBY', players: safePlayers };
            if (!isHost) return;
            updateLobbyUI();
            connections.forEach(c => c.send(msg));
        }

        async function startGame() {
            if (players.length < 3 && !confirm("¬øMenos de 3 jugadores? Va a ser un rondo aburrido.")) return;
            
            const btn = document.getElementById('btnStart');
            btn.innerText = "‚è≥ SORTEANDO CAMPO...";
            btn.disabled = true;

            const wordData = await getWordAndDescription();
            
            const impostor = players[Math.floor(Math.random() * players.length)];
            let turnOrder = [...players];
            turnOrder = shuffleArray(turnOrder).map(p => p.name);

            gameState = { wordData: wordData, impostorName: impostor.name };
            
            const msg = { 
                type: 'START', 
                wordData: wordData, 
                impostor: impostor.id,
                order: turnOrder
            };
            
            connections.forEach(c => c.send(msg));
            setupGame(wordData, impostor.id, turnOrder);

            btn.innerText = "‚öΩ ¬°PITIDO INICIAL! ‚öΩ";
            btn.disabled = false;
        }

        // --- FUNCI√ìN DEL JUEGO ARREGLADA ---
        function setupGame(wordData, impostorId, orderList) {
            showScreen('game');
            const amIImpostor = (peer.id === impostorId);
            
            const container = document.getElementById('roleContent');
            container.innerHTML = ''; // Limpiar contenido previo

            if (amIImpostor) {
                container.innerHTML = `
                    <div class="impostor-text">IMPOSTOR</div>
                    <p style="color: #666; font-size: 1.1rem;">Nadie sabe que eres t√∫. Finge saber la palabra.</p>
                `;
            } else {
                container.innerHTML = `
                    <div class="secret-word">${wordData.title}</div>
                    <div class="desc-container">
                        <div class="desc-text" id="descText">${wordData.desc}</div>
                        <button class="read-more-btn" onclick="toggleDesc()">‚¨á VER INFO COMPLETA</button>
                    </div>
                `;
            }

            // ALINEACI√ìN (Turnos arreglados)
            const ul = document.getElementById('turnOrderList');
            ul.innerHTML = '';
            orderList.forEach((name, index) => {
                const li = document.createElement('li');
                li.className = 'lineup-item';
                
                let extraHtml = '';
                if(index === 0) extraHtml = '<span class="turn-indicator">EMPIEZA ‚öΩ</span>';

                li.innerHTML = `
                    <div class="dorsal">${index + 1}</div>
                    <div class="player-name-turn">${name}</div>
                    ${extraHtml}
                `;
                ul.appendChild(li);
            });

            if (isHost) {
                document.getElementById('hostGameControls').classList.remove('hidden');
                document.getElementById('waitingReveal').classList.add('hidden');
            } else {
                document.getElementById('hostGameControls').classList.add('hidden');
                document.getElementById('waitingReveal').classList.remove('hidden');
            }
        }

        function toggleDesc() {
            const el = document.getElementById('descText');
            el.classList.toggle('expanded');
            const btn = document.querySelector('.read-more-btn');
            if (el.classList.contains('expanded')) {
                btn.innerText = "‚¨Ü OCULTAR";
            } else {
                btn.innerText = "‚¨á VER INFO COMPLETA";
            }
        }

        function revealGame() {
            const msg = { type: 'REVEAL', wordData: gameState.wordData, impostorName: gameState.impostorName };
            connections.forEach(c => c.send(msg));
            showResult(msg.wordData, msg.impostorName);
        }

        function showResult(wordData, impostorName) {
            showScreen('result');
            document.getElementById('finalWord').innerText = wordData.title;
            document.getElementById('finalDesc').innerText = wordData.desc;
            document.getElementById('finalImpostor').innerText = impostorName;
            
            if(isHost) {
                document.getElementById('hostRestartControls').classList.remove('hidden');
                document.getElementById('clientRestartWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostRestartControls').classList.add('hidden');
                document.getElementById('clientRestartWaiting').classList.remove('hidden');
            }
        }

        function returnToLobby() {
            broadcastLobby();
            connections.forEach(c => c.send({ type: 'RESET' }));
            showScreen('lobby');
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobbyList');
            list.innerHTML = '';
            document.getElementById('playerCount').innerText = players.length;
            players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-card-mini';
                
                let btnKick = '';
                if(isHost && p.id !== peer.id) {
                    btnKick = `<button class="kick-btn" onclick="kickPlayer('${p.id}')">EXPULSAR</button>`;
                }
                
                li.innerHTML = `<span>${p.name} ${p.isHost ? '<span class="host-badge">CAPI</span>' : ''}</span> ${btnKick}`;
                list.appendChild(li);
            });
        }
        
        function kickPlayer(id) {
            if(!confirm("¬øSacar a este jugador del equipo?")) return;
            const conn = connections.find(c => c.peer === id);
            if (conn) conn.close();
            players = players.filter(p => p.id !== id);
            connections = connections.filter(c => c.peer !== id);
            broadcastLobby();
        }

        function copyRoomCode() {
            const el = document.getElementById('roomIdDisplay');
            const text = el.innerText;
            if(text === "Cargando...") return;
            navigator.clipboard.writeText(text);
            el.style.backgroundColor = "#d1f2eb";
            el.innerText = "¬°C√ìDIGO COPIADO!";
            setTimeout(() => {
                el.style.backgroundColor = "#eef2f5";
                el.innerText = text;
            }, 1000);
        }
    </script>
</body>
</html>
