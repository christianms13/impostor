<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Impostor Malaguista PRO</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&family=Teko:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* PALETA M√ÅLAGA CF MODERNA */
            --mcf-sky: #6CABDD;
            --mcf-dark: #0a2c5c; /* Azul profundo */
            --mcf-gold: #D4AF37;
            --white: #ffffff;
            --danger: #ff4757;
            --success: #2ed573;
            --glass-bg: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-soft: 0 10px 40px rgba(0, 30, 60, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            color: #2d3436;
            overflow-x: hidden;
            position: relative;
            background-color: #001433;
        }

        /* --- FONDO PRO FRONTEND --- */
        /* Capa 1: Imagen Estadio */
        .bg-layer-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg/1200px-Estadio_La_Rosaleda_M%C3%A1laga_CF.jpg') no-repeat center center fixed;
            background-size: cover;
            z-index: -5;
            filter: grayscale(30%) contrast(110%);
        }
        /* Capa 2: Overlay Degradado Profesional */
        .bg-layer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(10, 44, 92, 0.92), rgba(108, 171, 221, 0.85));
            z-index: -4;
        }
        /* Capa 3: Pattern Grid (Toque Tech) */
        .bg-layer-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(var(--white) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.1;
            z-index: -3;
        }

        /* --- EMOJIS FLOTANTES --- */
        .emoji-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .floating-emoji {
            position: absolute;
            bottom: -10vh;
            font-size: 2rem;
            animation: floatUp linear infinite;
            z-index: 0;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; } /* M√°s visibles como pediste */
            90% { opacity: 0.8; }
            100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; }
        }

        /* --- CABECERA --- */
        header {
            text-align: center; margin-bottom: 30px; z-index: 10;
            position: relative;
        }
        .shield {
            width: 110px; height: auto; margin-bottom: 10px;
            filter: drop-shadow(0 0 25px rgba(255,255,255,0.5));
            animation: breathe 4s ease-in-out infinite;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        h1 {
            font-family: 'Teko', sans-serif; font-size: 4.5rem; text-transform: uppercase;
            margin: 0; line-height: 0.85; color: var(--white);
            text-shadow: 0 5px 15px rgba(0,0,0,0.3);
            letter-spacing: 1px;
        }
        .badge-pro {
            background: var(--mcf-gold); color: var(--mcf-dark);
            padding: 5px 15px; border-radius: 50px;
            font-size: 0.9rem; font-weight: 900; letter-spacing: 1px;
            text-transform: uppercase; display: inline-block; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        /* --- CONTENEDOR PRINCIPAL (Glassmorphism Pro) --- */
        .main-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            width: 100%; max-width: 900px;
            border-radius: 30px;
            padding: 40px;
            box-shadow: var(--shadow-soft), inset 0 0 0 1px var(--glass-border);
            text-align: center;
            position: relative; z-index: 10;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* --- UI ELEMENTS --- */
        input {
            width: 100%; padding: 20px; margin: 15px 0;
            background: #f1f5f9; border: 2px solid #cbd5e1;
            border-radius: 16px; color: var(--mcf-dark);
            font-family: 'Montserrat'; font-weight: 700; font-size: 1.2rem;
            text-align: center; outline: none; transition: all 0.3s;
        }
        input:focus { border-color: var(--mcf-sky); background: var(--white); box-shadow: 0 0 0 4px rgba(108, 171, 221, 0.2); }

        button {
            width: 100%; padding: 22px; margin-top: 15px;
            background: linear-gradient(135deg, var(--mcf-sky) 0%, var(--mcf-dark) 100%);
            color: var(--white); border: none; border-radius: 16px;
            font-family: 'Teko', sans-serif; font-size: 2rem; letter-spacing: 1px;
            cursor: pointer; text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(10, 44, 92, 0.3);
            position: relative; overflow: hidden; transition: all 0.3s;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(10, 44, 92, 0.5); }
        button:active { transform: scale(0.98); }

        button.secondary {
            background: transparent; border: 3px solid var(--mcf-dark); color: var(--mcf-dark);
            box-shadow: none;
        }
        button.secondary:hover { background: var(--mcf-dark); color: var(--white); }
        
        button.danger { background: linear-gradient(135deg, #ff6b6b, #ee5253); box-shadow: 0 10px 30px rgba(238, 82, 83, 0.3); }

        .hidden { display: none !important; }

        /* --- JUGADORES --- */
        .player-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 0; list-style: none; }
        .player-card {
            background: var(--white); border-radius: 15px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            transition: transform 0.2s;
        }
        .player-card:hover { transform: translateY(-2px); border-color: var(--mcf-sky); }
        .player-name { font-weight: 700; color: var(--mcf-dark); font-size: 1rem; margin-bottom: 5px; }
        .host-tag { font-size: 0.7rem; background: var(--mcf-gold); color: white; padding: 2px 8px; border-radius: 10px; font-weight: 800; }
        
        .kick-btn-mini {
            margin-top: 5px; font-size: 0.7rem; background: #ffeaa7; color: #d63031; 
            padding: 5px 10px; height: auto; width: auto; box-shadow: none; border: none;
        }

        /* --- JUEGO --- */
        .role-container {
            background: linear-gradient(to bottom right, #f8fafc, #f1f5f9);
            border-radius: 20px; padding: 30px; border: 1px solid #e2e8f0; margin-bottom: 30px;
        }
        .label { font-size: 0.8rem; color: #94a3b8; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; display: block; }
        
        .word-display { font-family: 'Teko'; font-size: 4rem; color: var(--mcf-dark); line-height: 1; margin-bottom: 15px; }
        .impostor-display { font-family: 'Teko'; font-size: 4.5rem; color: var(--danger); line-height: 1; animation: pulse 2s infinite; }

        /* DESCRIPCI√ìN PRO */
        .desc-wrapper { position: relative; text-align: left; background: var(--white); padding: 20px; border-radius: 15px; border-left: 5px solid var(--mcf-sky); }
        .desc-content { 
            font-size: 1.05rem; line-height: 1.6; color: #475569; 
            max-height: 80px; overflow: hidden; transition: max-height 0.5s ease; 
        }
        .desc-content.open { max-height: 600px; }
        .desc-fade {
            position: absolute; bottom: 40px; left: 0; width: 100%; height: 40px;
            background: linear-gradient(transparent, var(--white)); pointer-events: none;
            transition: opacity 0.3s;
        }
        .desc-content.open + .desc-fade { opacity: 0; }
        
        .toggle-btn {
            background: none; border: none; color: var(--mcf-sky); font-weight: 800;
            padding: 10px 0 0 0; width: 100%; text-align: center; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: none; margin: 0;
            font-size: 0.9rem;
        }
        .toggle-btn:hover { background: none; text-decoration: underline; transform: none; }

        /* ALINEACI√ìN */
        .lineup-container { background: var(--mcf-dark); color: white; border-radius: 20px; padding: 5px 0; overflow: hidden; }
        .lineup-row {
            display: flex; align-items: center; padding: 15px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .lineup-row:last-child { border-bottom: none; }
        .dorsal-circle {
            width: 40px; height: 40px; background: rgba(255,255,255,0.15); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Teko'; font-size: 1.5rem; margin-right: 15px; color: var(--mcf-sky);
        }
        .player-turn-name { font-size: 1.1rem; font-weight: 600; }
        .turn-badge { margin-left: auto; background: var(--mcf-gold); color: var(--mcf-dark); font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; font-weight: 900; }

        /* --- MODAL PERSONALIZADO --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 20, 40, 0.8); backdrop-filter: blur(5px);
            z-index: 1000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        
        .modal-box {
            background: var(--white); width: 90%; max-width: 400px;
            border-radius: 25px; padding: 30px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        
        .modal-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .modal-text { font-size: 1.2rem; font-weight: 600; color: #333; margin-bottom: 20px; }
        .modal-btn-group { display: flex; gap: 10px; }

        #roomIdDisplay {
            font-family: monospace; font-size: 1.8rem; font-weight: 700; color: var(--mcf-dark);
            background: #e2e8f0; padding: 20px; border-radius: 15px; border: 3px dashed #94a3b8;
            cursor: pointer; margin-top: 10px; width: 100%; word-break: break-all;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div class="bg-layer-image"></div>
    <div class="bg-layer-overlay"></div>
    <div class="bg-layer-pattern"></div>
    <div id="emojiContainer" class="emoji-container"></div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <span id="modalIcon" class="modal-icon">‚öΩ</span>
            <p id="modalMessage" class="modal-text">Mensaje</p>
            <div id="modalButtons" class="modal-btn-group">
                </div>
        </div>
    </div>

    <header>
        <img src="https://upload.wikimedia.org/wikipedia/it/8/80/Malaga_CF.png" alt="M√°laga CF" class="shield">
        <h1>IMPOSTOR<br>MALAGUISTA</h1>
        <div class="badge-pro">PRO MAX EDITION</div>
    </header>

    <div id="screen-menu" class="main-card">
        <h2 style="font-family:'Teko'; font-size: 2.5rem; margin:0 0 10px 0;">FICHAJE NUEVO</h2>
        <input type="text" id="myUsername" placeholder="Tu Nombre de Jugador" maxlength="12">
        <button onclick="createGame()">CREAR VESTUARIO</button>
        <div style="margin: 20px 0; font-weight: 800; color: #94a3b8; font-size: 0.9rem;">‚Äî O ‚Äî</div>
        <input type="text" id="joinInput" placeholder="C√≥digo del Partido">
        <button class="secondary" onclick="joinGame()">UNIRSE AL EQUIPO</button>
    </div>

    <div id="screen-lobby" class="main-card hidden">
        <h2 style="font-family:'Teko'; font-size: 3rem; margin:0;">VESTUARIO</h2>
        <p style="color: #64748b;">C√≥digo de acceso:</p>
        <div id="roomIdDisplay" onclick="copyRoomCode()">Cargando...</div>

        <div style="margin-top: 30px; text-align: left;">
            <span class="label">CONVOCATORIA (<span id="playerCount">0</span>)</span>
            <ul id="lobbyList" class="player-list"></ul>
        </div>

        <div id="hostControls" class="hidden" style="margin-top: 30px;">
            <button onclick="startGame()" id="btnStart">‚öΩ ¬°SALTAR AL CAMPO! ‚öΩ</button>
        </div>
        <div id="clientWaiting" class="hidden">
            <p style="color: var(--mcf-sky); font-weight: 800; margin-top: 25px; font-size: 1.2rem; animation: pulse 2s infinite;">ESPERANDO AL M√çSTER... ‚è±</p>
        </div>
    </div>

    <div id="screen-game" class="main-card hidden">
        <div class="role-container">
            <span class="label">TU POSICI√ìN T√ÅCTICA</span>
            <div id="roleContent"></div>
        </div>

        <div style="text-align: left;">
            <span class="label" style="margin-bottom: 15px; display:block;">11 INICIAL (ORDEN DE JUEGO)</span>
            <div id="turnOrderList" class="lineup-container"></div>
        </div>
        
        <div id="hostGameControls" class="hidden" style="margin-top: 20px;">
            <button class="danger" onclick="revealGame()">üõë PITIDO FINAL</button>
        </div>
        <p id="waitingReveal" class="hidden" style="margin-top:20px; color: #94a3b8; font-weight:700;">PARTIDO EN JUEGO... NO DIGAS NADA ü§´</p>
    </div>

    <div id="screen-result" class="main-card hidden">
        <h2 style="font-family: 'Teko'; font-size: 3.5rem; color: var(--mcf-dark); margin:0;">MARCADOR</h2>
        
        <div style="background: #f1f5f9; padding: 25px; border-radius: 15px; margin: 25px 0; border: 1px solid #e2e8f0;">
            <span class="label">LA PALABRA CLAVE</span>
            <div id="finalWord" class="word-display" style="font-size: 3rem;"></div>
            <p id="finalDesc" style="font-size: 1rem; color: #475569; font-style: italic; margin-top:10px; line-height:1.4;"></p>
        </div>

        <span class="label">EL INFILTRADO ERA</span>
        <h3 id="finalImpostor" style="font-family: 'Teko'; font-size: 4rem; color: var(--danger); margin: 0; line-height:1;"></h3>
        
        <div id="hostRestartControls" class="hidden">
            <button onclick="returnToLobby()">üîÑ NUEVO PARTIDO</button>
        </div>
        <p id="clientRestartWaiting" class="hidden" style="color: #94a3b8; margin-top:20px; font-weight:600;">RUEDA DE PRENSA...</p>
    </div>

    <script>
        // --- SISTEMA DE EMOJIS "COQUETTE CHAOS" ---
        const emojiContainer = document.getElementById('emojiContainer');
        const emojis = ["‚öΩ", "üíô", "ü§ç", "üêü", "üåä", "üèüÔ∏è", "üëü", "üéÄ", "‚ú®", "ü•ò", "üå¥", "üåû"];
        
        for(let i=0; i<50; i++) { // 50 emojis, mucha variedad
            let el = document.createElement('div');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.className = 'floating-emoji';
            // Aleatoriedad total
            el.style.left = Math.random() * 100 + 'vw';
            el.style.fontSize = (Math.random() * 2 + 1) + 'rem';
            el.style.opacity = (Math.random() * 0.4 + 0.3); // Opacidad visible (0.3 a 0.7)
            el.style.animationDuration = (Math.random() * 20 + 15) + 's'; // Lentos y majestuosos
            el.style.animationDelay = Math.random() * 20 + 's'; // Para que no salgan todos a la vez
            emojiContainer.appendChild(el);
        }

        // --- SISTEMA DE MODALES ---
        function showModal(message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('customModal');
            const icon = document.getElementById('modalIcon');
            const text = document.getElementById('modalMessage');
            const btnGroup = document.getElementById('modalButtons');
            
            text.innerText = message;
            btnGroup.innerHTML = '';

            if (type === 'error') icon.innerText = '‚ùå';
            else if (type === 'success') icon.innerText = '‚úÖ';
            else if (type === 'confirm') icon.innerText = '‚ùì';
            else icon.innerText = '‚öΩ';

            if (type === 'confirm') {
                const btnYes = document.createElement('button');
                btnYes.innerText = "S√ç";
                btnYes.style.width = "auto";
                btnYes.style.flex = "1";
                btnYes.onclick = () => { closeModal(); if(onConfirm) onConfirm(); };
                
                const btnNo = document.createElement('button');
                btnNo.innerText = "NO";
                btnNo.className = "secondary";
                btnNo.style.width = "auto";
                btnNo.style.flex = "1";
                btnNo.style.marginTop = "0"; // Override default
                btnNo.onclick = closeModal;
                
                btnGroup.appendChild(btnNo);
                btnGroup.appendChild(btnYes);
            } else {
                const btnOk = document.createElement('button');
                btnOk.innerText = "VALE";
                btnOk.onclick = closeModal;
                btnGroup.appendChild(btnOk);
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('customModal').classList.remove('active');
        }

        // --- DATABASE MASIVA ---
        const PALABRAS_JUEGO = [
          "Michael Jordan", "LeBron James", "Kobe Bryant", "Shaquille O'Neal", "Stephen Curry", "Magic Johnson", "Larry Bird", "Pau Gasol", "Marc Gasol", "Luka Doncic", "Giannis Antetokounmpo", "Kevin Durant", "James Harden", "Nikola Jokic", "Victor Wembanyama", "Dennis Rodman", "Scottie Pippen", "Kyrie Irving", "Allen Iverson", "Dirk Nowitzki", "Tim Duncan", "Yao Ming", "Steve Nash", "Kareem Abdul-Jabbar", "Wilt Chamberlain", "M√°laga CF", "La Rosaleda", "Isco", "Santi Cazorla", "Dely Vald√©s", "Ruud van Nistelrooy", "Jeremy Toulalan", "Willy Caballero", "Kameni", "Duda", "Weligton", "Julio Baptista", "Joaqu√≠n S√°nchez", "Salom√≥n Rond√≥n", "Camacho", "Sandro Ram√≠rez", "Eliseu", "Manuel Pellegrini", "Basti", "Lionel Messi", "Cristiano Ronaldo", "Diego Maradona", "Pel√©", "Johan Cruyff", "Zinedine Zidane", "Ronaldo Nazario", "Ronaldinho", "Andr√©s Iniesta", "Xavi Hern√°ndez", "Sergio Ramos", "Iker Casillas", "Gerard Piqu√©", "Carles Puyol", "Lamine Yamal", "Jude Bellingham", "Kylian Mbapp√©", "Erling Haaland", "Vinicius Jr", "Neymar", "Luis Su√°rez", "Luka Modric", "Toni Kroos", "David Beckham", "Antoine Griezmann", "Thibaut Courtois", "Oliver y Benji", "Bal√≥n de Oro", "Mundial de F√∫tbol", "Champions League", "√Årbitro", "VAR", "Penalti", "Tarjeta Roja", "Gol", "Porter√≠a", "Darth Vader", "Luke Skywalker", "Princesa Leia", "Yoda", "Han Solo", "Chewbacca", "Harry Potter", "Hermione Granger", "Ron Weasley", "Voldemort", "Dumbledore", "Hogwarts", "Frodo Bols√≥n", "Gandalf", "Gollum", "Sauron", "El Anillo √önico", "Spiderman", "Batman", "Joker", "Superman", "Iron Man", "Capit√°n Am√©rica", "Thor", "Hulk", "Thanos", "Wonder Woman", "Deadpool", "Wolverine", "Mickey Mouse", "Bob Esponja", "Homer Simpson", "Shrek", "Burro", "Fiona", "Buzz Lightyear", "Woody", "Elsa", "Olaf", "Barbie", "Ken", "Jack Sparrow", "Jon Snow", "Daenerys Targaryen", "Walter White", "Eleven", "Mi√©rcoles Addams", "El Profesor", "Super Mario", "Luigi", "Princesa Peach", "Bowser", "Yoshi", "Toad", "Pikachu", "Charizard", "Pok√©ball", "Ash Ketchum", "Sonic", "Link", "Zelda", "Steve", "Creeper", "Kratos", "Master Chief", "Among Us", "Impostor", "Tripulante", "Fortnite", "Minecraft", "Roblox", "League of Legends", "FIFA", "GTA", "Call of Duty", "Tetris", "Pac-Man", "Brad Pitt", "Leonardo DiCaprio", "Tom Cruise", "Will Smith", "Johnny Depp", "Angelina Jolie", "Jennifer Lawrence", "Marilyn Monroe", "Elvis Presley", "Michael Jackson", "Freddie Mercury", "Madonna", "Shakira", "Beyonc√©", "Rihanna", "Taylor Swift", "Lady Gaga", "Rosal√≠a", "Bad Bunny", "Eminem", "Perro", "Gato", "Hamster", "Conejo", "Loro", "Pez", "Tortuga", "Vaca", "Cerdo", "Oveja", "Caballo", "Gallina", "Gallo", "Pato", "Le√≥n", "Tigre", "Elefante", "Jirafa", "Oso", "Panda", "Mono", "Gorila", "Lobo", "Zorro", "√Åguila", "B√∫ho", "Ping√ºino", "Delf√≠n", "Ballena", "Tibur√≥n", "Pulpo", "Cocodrilo", "Serpiente", "Rana", "Dinosaurio", "T-Rex", "Drag√≥n", "Unicornio", "M√≥vil", "iPhone", "Ordenador", "Port√°til", "Televisi√≥n", "Mando", "C√°mara", "Reloj", "L√°mpara", "Bombilla", "Vela", "Mechero", "Caja", "Maleta", "Mochila", "Bolso", "Cartera", "Llaves", "Gafas", "Gafas de sol", "Paraguas", "Mesa", "Silla", "Sof√°", "Cama", "Almohada", "Manta", "Espejo", "Peine", "Cepillo de dientes", "Pasta de dientes", "Jab√≥n", "Champ√∫", "Toalla", "Papel higi√©nico", "Escoba", "Fregona", "Lavadora", "Nevera", "Microondas", "Horno", "Sart√©n", "Olla", "Plato", "Vaso", "Taza", "Cuchillo", "Tenedor", "Cuchara", "Botella", "Libro", "Cuaderno", "Bol√≠grafo", "L√°piz", "Tijeras", "Pegamento", "Mapa", "Bandera", "Moneda", "Billete", "Tarjeta de cr√©dito", "Anillo", "Collar", "Pizza", "Hamburguesa", "Patatas Fritas", "Sushi", "Tacos", "Burrito", "Pasta", "Arroz", "Huevo", "Pan", "Queso", "Chocolate", "Helado", "Tarta", "Fruta", "Manzana", "Pl√°tano", "Naranja", "Fresa", "Sand√≠a", "Leche", "Caf√©", "Cerveza", "Vino", "Coca-Cola", "Agua", "Coche", "Moto", "Bicicleta", "Autob√∫s", "Tren", "Metro", "Avi√≥n", "Barco", "Helic√≥ptero", "Cohete", "M√©dico", "Enfermera", "Polic√≠a", "Bombero", "Profesor", "Cocinero", "Camarero", "Astronauta", "Piloto", "Soldado", "Rey", "Reina", "Pirata", "Ninja", "Vampiro", "Zombi", "Fantasma", "Bruja", "Robot", "Alien", "Amor", "Odio", "Miedo", "Alegr√≠a", "Tristeza", "Suerte", "Tiempo", "Vida", "Muerte", "Boda", "Cumplea√±os", "Navidad", "Halloween", "Verano", "Invierno", "Sol", "Luna", "Lluvia", "Nieve", "Fuego", "Playa", "Monta√±a", "Ciudad", "Bosque", "Desierto", "Isla", "Hospital", "Escuela", "Supermercado", "Cine", "Restaurante", "Aeropuerto", "Parque", "Estadio", "Casa", "Castillo", "Espa√±a", "Madrid", "Barcelona", "M√°laga", "Par√≠s", "Torre Eiffel", "Londres", "Nueva York", "Estatua de la Libertad", "Roma", "Coliseo", "Egipto", "Pir√°mides", "China", "Muralla China", "Jap√≥n", "Espacio"
        ];

        // --- L√ìGICA DE JUEGO ---
        let peer = null;
        let connections = [];
        let isHost = false;
        let myName = "";
        let players = []; 
        let gameState = {}; 

        const screens = ['menu', 'lobby', 'game', 'result'];
        function showScreen(name) {
            screens.forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
            const el = document.getElementById(`screen-${name}`);
            el.classList.remove('hidden');
            // Trigger animation
            el.style.opacity = 0;
            el.style.transform = "translateY(20px)";
            setTimeout(() => {
                el.style.opacity = 1;
                el.style.transform = "translateY(0)";
            }, 50);
        }

        // WIKIPEDIA API AVANZADA
        async function getWordAndDescription() {
            const rawWord = PALABRAS_JUEGO[Math.floor(Math.random() * PALABRAS_JUEGO.length)];
            // Aumentado exchars a 600 y ajustado la query
            const url = `https://es.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&exchars=600&titles=${encodeURIComponent(rawWord)}&format=json&origin=*`;
            
            let description = "Informaci√≥n no disponible en la base de datos. ¬°Juega con lo que sepas!"; 

            try {
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId !== "-1") {
                    const extract = pages[pageId].extract;
                    if (extract && extract.length > 5) {
                        description = extract;
                    }
                }
            } catch (e) {
                console.log("Wiki fetch error:", e);
            }

            return { title: rawWord, desc: description };
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- PEERJS ---
        function createGame() {
            myName = document.getElementById('myUsername').value.trim() || "Malaguista";
            isHost = true;
            showModal("Creando vestuario...", "info");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                closeModal();
                document.getElementById('roomIdDisplay').innerText = id;
                players = [{ id: id, name: myName, isHost: true }];
                updateLobbyUI();
                showScreen('lobby');
                document.getElementById('hostControls').classList.remove('hidden');
            });

            peer.on('connection', (c) => {
                c.on('open', () => { c.on('data', (d) => handleDataHost(d, c)); });
                c.on('close', () => {
                    players = players.filter(p => p.id !== c.peer);
                    connections = connections.filter(con => con.peer !== c.peer);
                    broadcastLobby();
                });
            });
        }

        function joinGame() {
            myName = document.getElementById('myUsername').value.trim() || "Aficionado";
            const roomId = document.getElementById('joinInput').value.trim();
            if (!roomId) return showModal("¬°Falta el c√≥digo del partido!", "error");
            
            isHost = false;
            showModal("Conectando con el estadio...", "info");
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                const conn = peer.connect(roomId);
                conn.on('open', () => {
                    closeModal();
                    conn.send({ type: 'JOIN', name: myName, id: id });
                    connections = [conn]; 
                });
                conn.on('data', (d) => handleDataClient(d));
                conn.on('close', () => { showModal("Conexi√≥n perdida con el vestuario.", "error"); location.reload(); });
            });
        }

        function handleDataHost(data, connSource) {
            if (data.type === 'JOIN') {
                if (!players.find(p => p.id === data.id)) {
                    connections.push(connSource);
                    players.push({ id: data.id, name: data.name });
                    broadcastLobby();
                }
            }
        }

        function handleDataClient(data) {
            if (data.type === 'LOBBY') {
                players = data.players;
                showScreen('lobby');
                updateLobbyUI();
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('clientWaiting').classList.remove('hidden');
            }
            if (data.type === 'START') setupGame(data.wordData, data.impostor, data.order);
            if (data.type === 'REVEAL') showResult(data.wordData, data.impostorName);
            if (data.type === 'RESET') showScreen('lobby');
        }

        function broadcastLobby() {
            const safePlayers = players.map(p => ({ id: p.id, name: p.name, isHost: p.isHost }));
            const msg = { type: 'LOBBY', players: safePlayers };
            if (!isHost) return;
            updateLobbyUI();
            connections.forEach(c => c.send(msg));
        }

        async function startGame() {
            // RESTRICCI√ìN DE JUGADORES ELIMINADA
            
            const btn = document.getElementById('btnStart');
            btn.innerText = "‚è≥ SORTEANDO CAMPO...";
            btn.disabled = true;

            const wordData = await getWordAndDescription();
            
            const impostor = players[Math.floor(Math.random() * players.length)];
            let turnOrder = [...players];
            turnOrder = shuffleArray(turnOrder).map(p => p.name);

            gameState = { wordData: wordData, impostorName: impostor.name };
            
            const msg = { 
                type: 'START', 
                wordData: wordData, 
                impostor: impostor.id,
                order: turnOrder
            };
            
            connections.forEach(c => c.send(msg));
            setupGame(wordData, impostor.id, turnOrder);

            btn.innerText = "‚öΩ ¬°PITIDO INICIAL! ‚öΩ";
            btn.disabled = false;
        }

        function setupGame(wordData, impostorId, orderList) {
            showScreen('game');
            const amIImpostor = (peer.id === impostorId);
            
            const container = document.getElementById('roleContent');
            container.innerHTML = ''; 

            if (amIImpostor) {
                container.innerHTML = `
                    <div class="impostor-display">IMPOSTOR</div>
                    <p style="color: #64748b; font-size: 1.2rem; font-weight:600; margin-top:10px;">Nadie sabe que eres t√∫.<br>Finge, miente y gana.</p>
                `;
            } else {
                container.innerHTML = `
                    <div class="word-display">${wordData.title}</div>
                    <div class="desc-wrapper">
                        <div class="desc-content" id="descText">${wordData.desc}</div>
                        <div class="desc-fade"></div>
                        <button class="toggle-btn" onclick="toggleDesc()">‚¨á VER INFO COMPLETA</button>
                    </div>
                `;
            }

            const listContainer = document.getElementById('turnOrderList');
            listContainer.innerHTML = '';
            orderList.forEach((name, index) => {
                const row = document.createElement('div');
                row.className = 'lineup-row';
                
                let badge = '';
                if(index === 0) badge = '<span class="turn-badge">EMPIEZA</span>';

                row.innerHTML = `
                    <div class="dorsal-circle">${index + 1}</div>
                    <div class="player-turn-name">${name}</div>
                    ${badge}
                `;
                listContainer.appendChild(row);
            });

            if (isHost) {
                document.getElementById('hostGameControls').classList.remove('hidden');
                document.getElementById('waitingReveal').classList.add('hidden');
            } else {
                document.getElementById('hostGameControls').classList.add('hidden');
                document.getElementById('waitingReveal').classList.remove('hidden');
            }
        }

        function toggleDesc() {
            const el = document.getElementById('descText');
            const btn = document.querySelector('.toggle-btn');
            el.classList.toggle('open');
            
            if (el.classList.contains('open')) {
                btn.innerHTML = "‚¨Ü OCULTAR INFO";
            } else {
                btn.innerHTML = "‚¨á VER INFO COMPLETA";
            }
        }

        function revealGame() {
            const msg = { type: 'REVEAL', wordData: gameState.wordData, impostorName: gameState.impostorName };
            connections.forEach(c => c.send(msg));
            showResult(msg.wordData, msg.impostorName);
        }

        function showResult(wordData, impostorName) {
            showScreen('result');
            document.getElementById('finalWord').innerText = wordData.title;
            document.getElementById('finalDesc').innerText = wordData.desc;
            document.getElementById('finalImpostor').innerText = impostorName;
            
            if(isHost) {
                document.getElementById('hostRestartControls').classList.remove('hidden');
                document.getElementById('clientRestartWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostRestartControls').classList.add('hidden');
                document.getElementById('clientRestartWaiting').classList.remove('hidden');
            }
        }

        function returnToLobby() {
            broadcastLobby();
            connections.forEach(c => c.send({ type: 'RESET' }));
            showScreen('lobby');
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobbyList');
            list.innerHTML = '';
            document.getElementById('playerCount').innerText = players.length;
            players.forEach(p => {
                const li = document.createElement('li');
                li.className = 'player-card';
                
                let btnKick = '';
                if(isHost && p.id !== peer.id) {
                    btnKick = `<button class="kick-btn-mini" onclick="kickPlayer('${p.id}')">ROJA üü•</button>`;
                }
                
                li.innerHTML = `
                    <span class="player-name">${p.name}</span>
                    ${p.isHost ? '<span class="host-tag">CAPI</span>' : ''}
                    ${btnKick}
                `;
                list.appendChild(li);
            });
        }
        
        function kickPlayer(id) {
            showModal("¬øSacar tarjeta roja y expulsar?", "confirm", () => {
                const conn = connections.find(c => c.peer === id);
                if (conn) conn.close();
                players = players.filter(p => p.id !== id);
                connections = connections.filter(c => c.peer !== id);
                broadcastLobby();
            });
        }

        function copyRoomCode() {
            const el = document.getElementById('roomIdDisplay');
            const text = el.innerText;
            if(text === "Cargando...") return;
            navigator.clipboard.writeText(text);
            showModal("¬°C√≥digo copiado al portapapeles!", "success");
        }
    </script>
</body>
</html>
